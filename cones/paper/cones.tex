%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[sigplan,10pt]{acmart}\settopmatter{}


%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmConference[LICS'18]{ACM/IEEE Symposium on Logic in Computer Science}{9-12 July, 2018}{Oxford, UK}
\acmYear{2018}
\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2017}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
%\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
%\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\let\NOTARTICLE=1
\let\FEWFONTS=1
\let\BEAMER=1
\let\G\undefined
\let\C\undefined
\let\W\undefined
\let\U\undefined
\let\E\undefined
\input{../../common/preamble}
\renewcommand{\dv}{{\lightning}}
\newcommand{\oracle}{{\textsf{oracle}}}


\begin{document}

%% Title information
\title{A Fully Abstract Game Semantics for Countable Nondeterminism}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{W. J. Gowers}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{0000-0002-4513-9618}             %% \orcid is optional
\affiliation{
  \department{Department of Computer Science}              %% \department is recommended
  \institution{University of Bath}            %% \institution is required
  \streetaddress{Claverton Down Road}
  \city{Bath}
  \postcode{BA2 7QY}
  \country{United Kingdom}                    %% \country is recommended
}
\email{W.J.Gowers@bath.ac.uk}

\author{James Laird}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{0000-0002-4513-9618}             %% \orcid is optional
\affiliation{
  \department{Department of Computer Science}              %% \department is recommended
  \institution{University of Bath}            %% \institution is required
  \streetaddress{Claverton Down Road}
  \city{Bath}
  \postcode{BA2 7QY}
  \country{United Kingdom}                    %% \country is recommended
}
\email{J.D.Laird@bath.ac.uk}

%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
  The concept of fairness for a concurrent program means that the program must be able to exhibit an unbounded amount of nondeterminism without diverging. Game semantics models of nondeterminism show that this is hard to implement; for example, Harmer and McCusker's model only admits infinite nondeterminism if there is also the possibility of divergence. 
  We solve a long standing problem by giving a fully abstract game semantics for a simple stateful language with a countably infinite nondeterminism primitive. 
  We see that doing so requires us to keep track of infinitary information about strategies, as well as their finite behaviours.
  The unbounded nondeterminism gives rise to further problems, which can be formalized as a lack of continuity in the language. 
  In order to prove adequacy for our model (which usually requires continuity), we develop a new technique in which we simulate the nondeterminism using a deterministic stateful construction, and then use combinatorial techniques to transfer the result to the nondeterministic language. 
  Lastly, we prove full abstraction for the model; because of the lack of continuity, we cannot deduce this from definability of compact elements in the usual way, and we have to use a stronger universality result instead. 
  We discuss how our techniques may also be applied to Tsukada and Ong's model of PCF with finite nondeterminism, yielding an alternative proof of computational adequacy.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10003752.10010124.10010131.10010133</concept_id>
<concept_desc>Theory of computation~Denotational semantics</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[300]{Theory of computation~Denotational semantics}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{semantics, nondeterminism, games and logic}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

Text of paper \ldots

\section{Idealized Algol with Countable Nondeterminism}

The language that we will be modelling is Idealized Algol \cite{SamsonGuyIAPassive} extended with an additional constant $\wn$ representing countable nondeterminism.  
This is similar to the approach adopted in \cite{mcCHFiniteND}, which extends Idealized Algol with \emph{finite} nondeterminism.  
The types of the language are defined inductively as follows:
\[
  T \Coloneqq \nat \mid \com \mid \Var \mid T \to T\,.
  \]
Meanwhile, the terms are those given in \cite{SamsonGuyIAPassive}, together with the nondeterministic choice:
\begin{IEEEeqnarray*}{RCL}
  M & \Coloneqq & x \mid \lambda x . M \mid M\;M \mid \Y_T M \mid \\
  && \n \mid \skipp \mid \suc M \mid \pred M \mid \\
  && \IfO M\;M\;M \mid M;M \mid \\
  && M \coloneqq M \mid \deref M \mid \\
  && \neww_T\;M \mid \mkvar M\;M \mid \wn\,.
\end{IEEEeqnarray*}

The typing rule for $\wn$ is $\Gamma \vdash \wn\from\nat$.
We shall use the letter $v$ to range over variables of type $\Var$.  

The value forms in the language are given by
\[
  V \Coloneqq \skipp \mid \n \mid \lambda x.M \mid v \mid \mkvar
  \]
We define predicates $M \converges V$ ($M$ may converge to $V$) and $M\mustconverge$ ($M$ must converge) inductively to give a big-step operational semantics for our language.  
We give a selection of the appropriate rules in Figure \ref{fig:ia-os}; this presentation is almost identical to that given in \cite{mcCHFiniteND}, with a rule for countable nondeterminism replacing their rule for finite nondeterminism.  
In each rule, $\ia{s}{M}$ is a \emph{configuration} of the language, where $M$ is a term, and $s$ is a \emph{store}; i.e., a function from the set of variables free in $M$ to the set of natural numbers.  
If $s$ is a store and $v$ a variable, we write $\stup s v n$ for the state formed by updating the value of the variable $v$ to $n$.

\begin{figure*}
  \begin{mathpar}
    \inferrule*{\ia s N \converges \ia {s'} \n \\ \ia {s'} M \converges \ia {s''} v}
    {\ia s {M \coloneqq N} \converges \ia {\stup {s''} v n} \skipp}
    \and
    \inferrule*[right=${s'(v) = n}$]{\ia s M \converges \ia {s'} v}
    {\ia s {\deref M} \converges \ia {s'} \n}
    \and
    \inferrule*{\ia s M \converges \ia {s'} \skipp \\ \ia {s'} N \converges \ia {s''} V}
    {\ia s {M;N} \converges \ia {s''} V}
    \and
    \inferrule*{\ia {\stup s v 0} M \converges \ia {\stup{s'} v n} V}
    {\ia s {\new_T\;\lambda v.M} \converges \ia {s'} V}
    \and
    \inferrule*[right=$n\in\bN$]{\ia s {M \n} \converges \ia {s'} V}
    {\ia s {M \wn} \converges \ia {s'} V}
    \and
    \inferrule*{\forall n\in\bN.\ia s {M \n}\mustconverge}
    {\ia s {M \wn} \mustconverge}
    \and
    \inferrule*{\ia s M \mustconverge \\ \forall \ia {s'} {\lambda x.M'}\esuchthat \ia s M \converges \ia {s'} {\lambda x.M'} \Rightarrow \ia {s'}{M'[N/x]}\mustconverge}
    {\ia s {M\;N}\mustconverge}
  \end{mathpar}
  \caption{Operational semantics of Idealized Algol with Countable Nondeterminism}
  \label{fig:ia-os}
\end{figure*}

Given a term $M$ of ground type $\com$ or $\nat$, a proof $\pi$ that $\ia s M\converges V$ or that $\ia S M \not\mustconverge$ gives rise to a (possibly infinite) sequence of natural numbers corresponding to a bottom-to-top, left-to-right reading of the natural numbers $n$ used in the rules for $\wn$.  
We call such a sequence an \emph{evaluation} of the configuration $\ia s M$.  
It is perhaps easier to view this from the perspective of a small-step reduction: the sequence of numbers is formed by listing the different values that the nondeterminism constant $\wn$ decays to over the course of the evaluation $\pi$.  

If $\ia\emptyset M$ is a configuration with empty store, we call $M$ a \emph{closed term}.  
Let $T$ be an Idealized Algol type, and let $M,N\from T$ be closed terms.
Then we write $M\lmam N$ if for all compatible contexts $C[-]$ of ground type we have
\begin{gather*}
  C[M]\converges V \Rightarrow C[N] \converges V\\
  C[M]\mustconverge \Rightarrow C[N] \mustconverge
\end{gather*}

We write $M\emam N$ if $M\lmam N$ and $N\lmam M$.

One aspect of the language that makes it particularly difficult to model is that function application is not continuous, either with respect to functions or with respect to arguments.  

For example, it is easy to write a sequence of functions ${<}\!n \from \nat \to \nat$ that return $0$ if their argument is less than $n$ and diverge otherwise:

\begin{align*}
  &{<}0 = \lambda m.\Omega \\
  &{<}1 = \lambda m.\IfO m\;\0\;\Omega \\
  &{<}2 = \lambda m.\IfO m\;\0\;(\IfO (\pred m)\;\0\;\Omega)\\
  \cdots
\end{align*}
It is easy enough to see (for example, by the denotational semantics) that the least upper bound of these functions is the function $\lambda x.\0$.  
However, it is clear that ${<}n\;\wn\not\mustconverge$ for each $n$, while $\lambda x.\0\;\wn$ must converge to $\0$.  
Thus, $\lambda x.\0\;\wn$ is not the least upper bound of the ${<}n\;\wn$.

This is a bit of a problem, since continuity often plays an important role in full abstraction proofs -- firstly, for proving Computational Adequacy of the recursion combinator, and, secondly, for deducing full abstraction from definability of compact elements.
Semantically, we shall deal with the first problem by adopting a novel approach to Computational Adequacy, and with the second problem by appealing to the stronger \emph{universality} result: namely, that every \emph{recursive} strategy is definable.

\section{Game Semantics}

We will use the Hyland-Ong version of Game Semantics, as in \cite{SamsonGuyIAPassive}.

\subsection{Arenas}

An \emph{arena} is given by a triple $A=(M_A,\lambda_A,\ts_A)$, where
\begin{itemize}
  \item $M_A$ is a countable set of moves,
  \item $\lambda_A\from m_A\to\OP\times\QA$ designates each move as either an \emph{$O$-move} or a \emph{$P$-move}, and as either a \emph{question} or an \emph{answer}.  
    We define $\lambda_A^{OP}=\pr_1\circ\lambda_A$ and $\lambda_A^{QA}=\pr_2\circ\lambda_A$.  
    We also define $\neg\from\OP\times\QA\to\OP\times\QA$ to be the function that reverses the values of $O$ and $P$ while leaving $\QA$ unchanged.
  \item $\ts_A$ is an \emph{enabling relation} between $M_A+\{*\}$ and $M_A$ satisfying the following rules:
    \begin{itemize}
      \item If $a\ts_A b$ and $a\ne b$, then $\lambda_A^{OP}(a)\neq\lambda_A^{OP}(b)$.  
      \item If $*\ts_A a$, then $\lambda_A(a)=OQ$ and $b\nts_A a$ for all $b\in M_A$.
      \item If $a\ts_A b$ and $b$ is an answer, then $a$ is a question.
    \end{itemize}
    We say that a move $a\in M_A$ is \emph{initial} in $A$ if $*\ts_A a$.
\end{itemize}

Our base arenas will be the \emph{flat arenas} for the types $\nat$ and $\com$.  
Given a set $X$, the flat arena on $X$ is the arena with a single $O$-question $q$ and a $P$-answer $x$ for each $x\in X$, where $*\ts q$ and $q\ts x$ for each $x$.  
The denotation of the type $\nat$ will be the flat arena $\bN$ on the set of natural numbers, while the denotation of the type $\com$ will be the flat arena $\bC$ on the singleton set $\{a\}$.

Given an arena $A$, a \emph{justified string} in $A$ is a sequence $s$ of moves in $A$, together with \emph{justification pointers} that go from move to move in the sequence in such a way that every non-initial move $m$ in $s$ has exactly one justification pointer going back to an earlier move $n$ in $s$ such that $n\ts_A m$.  
We say that $n$ \emph{justifies} $m$.  
It is easy to see that every justified string must begin with an initial move, an hence with an $O$-question.  

A \emph{legal play} $s$ is a justified string in $A$ that strictly alternates between $O$-moves and $P$-moves and is such that the corresponding $QA$-sequence formed by applying $\lambda_A^{QA}$ to terms is well-bracketed.
We write $L_A$ for the set of legal plays in $A$.

\subsection{Games and strategies}

We follow the approach taken by Abramsky and McCusker \cite{SamsonGuyIAPassive} -- a middle road between the \emph{arenas} of Hyland and Ong and the \emph{games} of \cite{ajmPcf} that makes the linear structure more apparent.

Let $s$ be a legal play in some arena $A$.  
If $m$ and $n$ are moves in $s$ such that there is a chain of justification pointers leading from $m$ back to $n$, we say that $n$ \emph{hereditarily justifies} $m$.  
Given some set $S$ of initial moves in $s$, we write $s\vert_S$ for the subsequence of $s$ made up of all those moves that are hereditarily justified by some move in $S$.

A \emph{game} is a tuple $A=(M_A,\lambda_A,\ts_A,P_A)$, where $(M_A,\lambda_A,\ts_A)$ is an arena and $P_A$ is a non-empty prefix-closed set of legal plays in that arena such that if $s\in P_A$ and $I$ is a non-empty set of initial moves in $s$, then $s\vert_I\in P_A$.

Our base games will be the games $\bN$ and $\bC$ on the arenas of the same names, where $P_{\bN}=\{\emptyplay,q\}\cup\{qn\suchthat n\in\bN\}$ and $\bC = \{\emptyplay,q,qa\}$.  

\subsubsection{Multiplicatives}

Let $A,B$ be games.  
We define games $A\tensor B$ and $A\implies B$ as follows.
\begin{IEEEeqnarray*}{RCL}
  M_{A\tensor B} & \quad=\quad & M_A + M_B\,. \\
  \lambda_{A\tensor B} & = & [\lambda_A,\lambda_B]\,.\\
  *\ts_{A\tensor B} n & \Leftrightarrow & * \ts_A n \text{ or } * \ts_B n\,. \\
  m \ts_{A\tensor B} n & \Leftrightarrow & m \ts_A n\text{ or } m \ts_B n\,.\\
  P_{A\tensor B} & = & \{s\in L_{A\tensor B}\suchthat s\vert_A\in P_A\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}
\begin{IEEEeqnarray*}{RCL}
  M_{A\implies B} & \quad=\quad & M_A + M_B\,. \\
  \lambda_{A\implies B} & = & [\neg\circ\lambda_A,\lambda_B]\,.\\
  *\ts_{A\implies B} n & \Leftrightarrow & * \ts_B m\,.\\[1.0ex]
  m \ts_{A\implies B} n & \Leftrightarrow & \mbox{\pbox\textwidth{$m \ts_A n$ or $m\ts_B n$ \\ or (for $m\neq *$) $ * \ts_B m$ and $* \ts_A n$\,.}} \\[1.0ex]
  P_{A\implies B} & = & \{s\in L_{A\implies B}\suchthat s\vert_A\in P_A\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}

\subsubsection{Modelling countable nondeterminism}

Our definition of a strategy will be modelled upon that given in \cite{mcCHFiniteND}.  
We model nondeterministic computations by relaxing the determinism constraint on strategies -- so player $P$ may have multiple replies to any given $O$-move.  

In addition, we have to keep track of any possible divergence in the computation; this is so we can distinguish terms such as
\begin{mathpar}
  \IfO \wn\;\Omega\;\0 \and \0\,,
\end{mathpar}
where the term on the right must converge (to $\0$), while the term on the left has a possible divergence.  
The traditional way of representing divergences in game semantics is by a partiality in the strategy; i.e., an $O$-move to which $P$ has no reply, but this partiality will be obscured by the alternative behaviour in the denotation of the strategy on the left.  

We follow \cite{mcCHFiniteND} by modelling a strategy as a pair $(T_\sigma,D_\sigma)$, where $T_\sigma$ is a nondeterministic strategy in the usual sense and $D_\sigma$ is a set of $O$-plays after which there is a possibility of divergence.  

Tracking divergences explicitly in this way requires some care when we compose strategies.  
Specifically, we need to be able to add new divergences into strategies when they arise through `infinite chattering' or \emph{livelock}.  
For example, the denotation of the term
\[
  M = \Y_{\nat\to\nat}(\lambda f.\lambda n.n;(f n))\,,
  \]
where $n;P$ is a shorthand for $\IfO n\;P\;P$, is given by a total strategy, without divergences: namely the strategy $\mu$ with plays of the form
\[
  \begin{array}{cc}
    \mathbf{\bN} & \mathbf{\bN} \\
    & q \\
    q & \\
    n_1 & \\
    q & \\
    n_2 & \\
    \vdots &
  \end{array}\,.
  \]
However, when we compose this strategy with any total strategy for $\bN$ on the left, we expect the resulting strategy to contain divergences, since the term $M \n$ diverges for any $\n$.

The approach adopted in \cite{mcCHFiniteND} is to check specifically for infinite chattering between strategies $\sigma\from A\implies B$ and $\tau\from B\implies C$ by checking whether the set $\sigma\|\tau$ contains any infinite increasing sequence of plays ending with moves in $B$.  
If there is such a sequence, then it restricts to some $O$-position in $\sigma;\tau$ and we add in a divergence at that position.  

This works very satisfactorily for finite nondeterminism, but not at all for countable nondeterminism.  
To see why, consider the term
\[
  N = \Y_{\nat\to\nat\to\nat}(\lambda g.\lambda m n.\IfO m\;\0\;n;(g\;(\pred m)\;n))\wn
  \]
This term first chooses a natural number $m$, and then reads from its input $n$ for a total of $m$ times before eventually returning $\0$.  
Thus, its denotation is the strategy $\nu$ with maximal plays of the form:
\[
  \begin{array}{cc}
    \mathbf{\bN} & \mathbf{\bN} \\
    & q \\
    q & \\
    n_1 & \\
    \vdots & \\
    q & \\
    n_m & \\
    & 0
  \end{array}\,.
  \]
Note that this strategy strictly contains the one we considered before, and therefore that the denotation of
\[
  \IfO \wn M N
  \]
has the same denotation as $N$, even though it has all the divergent evaluations of $M$, while $N\n\mustconverge$ for all $\n$.
Moreover, if we try to compose $\deno{N}$ with the strategy on $\bN$ that always returns $1$, then we end up with an infinite increasing sequence of positions, which triggers the introduction of a divergence into the composite -- even though no divergence occurs in the evaluation of $N$.

Aside from making violating soundness for the model, this example actually leads to composition not being associative if we naively extend the Harmer-McCusker model from finite to infinite nondeterminism (e.g., see \cite[4.4.1]{RusssThesis}).  

Somehow, the crucial point is that we need to distinguish between terms like $M$, which contain infinite sequences of moves, and terms like $N$, which contain arbitrarily large finite sequences of moves.  
The way that we do this is by making the infinite sequences of moves explicit in our strategies, in the style of \cite{RoscoeCspInfinite} and \cite{LevyGsInfinite}.  
Then the denotation of $M$ will contain an infinite sequence, while the denotation of $N$ will contain arbitrarily long finite sequences, but no infinite sequences.  

The games in our model will be the same as those that we considered in the last section, but our definition of a strategy will change.

\subsubsection{Strategies}

Given an arena $A$, we define an \emph{infinite justified string} in the obvious way.  
We define $\bar{P_A}$ to be $P_A$ together with the set of all those infinite justified sequences that have all finite prefixes in $P_A$.

Let $A$ be a game.  
A \emph{strategy} $\sigma$ for $A$ is a pair $(T_\sigma,D_\sigma)$, where:
\begin{itemize}
  \item $T_\sigma$ is a non-empty prefix-closed subset of $\bar{P_A}$ such that if $s\in T_\sigma$ is a $P$-position and $sa\in P_A$ then $sa\in T_\sigma$.
  \item $D_\sigma\subset \bar{P_A}$ is a postfix-closed set of plays in $\bar{P_A}$ that either end with an $O$-move or are infinite.  
    We require $D_\sigma$ to obey the following rules:
    \begin{description}
      \item[Divergences come from plays] If $d\in D_\sigma$ then there exists some $s\prefix d$ such that $s\in T_\sigma\cap D_\sigma$.
      \item[Diverge-or-reply] If $s\in T_\sigma$ is an $O$-position, then either $s\in D_\sigma$ or $sa\in T_\sigma$ for some legal play $sa$.
      \item[Infinite positions are divergent] If $s\in T_\sigma$ is infinite, then $s\in D_\sigma$.
    \end{description}
\end{itemize}

\subsubsection{Composition of strategies}

Given games $A,B,C$, we define a justified string over $A,B,C$ to be a sequence $\s$ of moves with justification pointers from all moves except the initial moves in $C$.  
Given such a string, we may form the restrictions $\s\vert_{A,B}$ and $\s\vert_{B,C}$ by removing all moves in either $C$ or $A$, together with all justification pointers pointing into these games.  
We define $\s\vert_{A,C}$ to be the sequence formed by removing all moves from $B$ from $\s$ and all pointers to moves in $B$, \emph{unless} we have a sequence of pointers $a \to b \to c$, in which case we replace them with a pointer $a \to c$.

We call such a sequence $\s$ a \emph{legal interaction} if $\s\vert_{A,B}\in P_{A\implies B}$, $\s\vert_{B,C}\in P_{B\implies C}$ and $\s\vert_{A,C}\in P_{A\implies C}$.  
We write $\Int_\infty(A,B,C)$ for the set of (possibly infinite) legal interactions between $A$, $B$ and $C$.

Now, given strategies $\sigma\from A \implies B$ and $\tau\from B \implies C$, we define
\[
  T_\sigma\|T_\tau = \{\s\in\Int_\infty(A,B,C)\suchthat \s\vert_{A,B}\in T_\sigma,\;\s\vert_{B,C}\in T_\tau\}\,,
  \]
and then set
\[
  T_{\sigma;\tau} = \{\s\vert_{A,C}\suchthat \s\in T_\sigma\|T_\tau\}\,.
  \]
As for divergences in $\sigma;\tau$, our approach is actually simpler than that in \cite{mcCHFiniteND}; we set
\[
  D_\sigma\dv D_\tau = \left\{\s\in \Int_\infty(A,B,C)\;\middle|\; \mbox{\pbox{\textwidth}{\textbf{either} $\s\vert_{A,B}\in D_\sigma$\\ \hspace*{12pt}and $s\vert_{B,C}\in T_\tau$ \\ \textbf{or} $\s\vert_{A,B}\in T_\sigma$ \\\hspace*{12pt}and $s\vert_{B,C}\in D_\tau$}}\right\}\,.
  \]
We then set
\[
  D_{\sigma;\tau} = \pocl_{A\implies C}\{\s\vert_{A,C}\suchthat\s\in D_\sigma\dv D_\tau\}\,,
  \]
where $\pocl X$ denotes the \emph{postfix closure} of $X$; i.e., the set of all $O$-plays in $P_{A\implies C}$ that have some prefix in $X$.

Note that there is no need to consider separately, as Harmer and McCusker do, divergences that arise through `infinite chattering': in our model, a case of infinite chattering between strategies $\sigma$ and $\tau$ is itself a legal interaction between the two strategies, which is necessarily divergent (because it is infinite) and therefore gives rise to some divergence in $\sigma;\tau$.

We need to impose one more condition on strategies:
\begin{definition}
  Let $\sigma$ be a strategy for a game $A$.  
  We say that $\sigma$ is \emph{complete} if $T_\sigma=\bar{T_\sigma}$; i.e., $T_\sigma$ contains an infinite position $s$ if it contains every finite prefix of $s$.  
\end{definition}

Any finite-nondeterminism strategy in the sense of \cite{mcCHFiniteND} may be interpreted as a complete strategy by enlarging it with all its infinite limiting plays.  
However, when we introduce countable nondeterminism, we introduce the possibility of strategies that are not complete.  
For example, the strategy $\nu$ that we mentioned above has an infinite increasing sequence of plays $q0\prefix q0q0\prefix \cdots$, but has no infinite play corresponding to its limit.  
Nonetheless, we do not want to allow arbitrary strategies: for example, the strategy $\mu$ above should include the infinite play $qq0q0\dots$; the strategy $\mu^\circ$ formed by removing this infinite play has no meaning in our language.  
Indeed, if we compose $\mu^\circ$ with the strategy $\0$ for $\bN$ on the left, then the resulting strategy does not satisfy diverge-or-reply.

\begin{definition}
  Let $\sigma$ be a strategy for a game $A$.  
  We say that $\sigma$ is \emph{locally complete} if it may be written as the union of countably many complete strategies; i.e., there exist $\sigma_n$ such that $T_\sigma=\bigcup T_{\sigma_n}$ and $D_\sigma=\bigcup D_{\sigma_n}$.
\end{definition}

From now on, we will use `strategy' to mean \emph{locally complete strategy}.

We need to show that the composition of locally complete strategies is locally complete.  
Note that this does not hold for \emph{complete} strategies: for example, our term $N$ above can be written as $N'\;\wn$, where $N'$ is a deterministic term with complete denotation $\nu'$.  
Then we have $\nu=\top_{\bN};\nu'$, but $\nu$ is not complete.
However, we can show that the composition of \emph{deterministic} complete strategies is complete; since a locally complete strategy may always be written as the union of complete deterministic strategies, this is sufficient to show that the composition of locally complete strategies is locally complete.

\begin{definition}
  We say that a strategy $\sigma$ for a game $A$ is \emph{deterministic} if
  \begin{itemize}
    \item it is complete;
    \item whenever $sab,sac$ are $P$-plays in $T_\sigma$ we have $b=c$ and the justifier of $b$ is the justifier of $c$;
    \item If $s\in D_\sigma$ then either $s$ is infinite or there is no $a$ such that $sa\in T_\sigma$.
  \end{itemize}
\end{definition}

\begin{lemma}
  Let $A,B,C$ be games and let $\sigma\from A\implies B$, $\tau\from B\implies C$ be deterministic complete strategies.  
  Then $\sigma;\tau$ is complete.
  \label{lem:complete-deterministic-composition}
\end{lemma}
\begin{proof}
  The proof relies on a lemma from \cite{hoPcf} that states (in our language) that if $\sigma$ and $\tau$ are deterministic strategies and $s\in T_{\sigma;\tau}$ then there is a unique minimal $\s\in T_\sigma\|T_\tau$ such that $\s\vert_{A,C}=s$.  
  That means that if $s_1\prefix s_2\prefix \cdots$ is an infinite increasing sequence of plays in $T_{\sigma;\tau}$, with infinite limit $s$, then there is a corresponding infinite increasing sequence of legal interactions $\s_1 \prefix \s_2 \prefix \cdots$.  
  Then the limit of this sequence is an infinite legal interaction $\s$ and we must have $\s\vert_{A,B}\in\sigma$, $\s\vert_{B,C}\in\tau$ by completeness of $\sigma$ and $\tau$.  
  Therefore, $s=\s\vert_{A,C}\in T_{\sigma;\tau}$.
\end{proof}

\begin{corollary}
  The composition of strategies $\sigma\from A\implies B$ and $\tau\from B \implies C$ is a well-formed strategy for $A\implies C$.
  \label{cor:diverge-or-reply}
\end{corollary}
\begin{proof}
  The only tricky point is establishing that diverge-or-reply holds for $\sigma;\tau$.  
  Again, it is sufficient to prove this in the case that $\sigma$ and $\tau$ are deterministic and complete.
  Then it essentially follows from the argument used in \cite{abramskyjagadeesangames} that shows that a partiality at an $O$-position $s\in T_{\sigma;\tau}$ must arise either from a partiality in $T_\sigma$ or $T_\tau$ or from `infinite chattering' between $\sigma$ and $\tau$.  
  In the first case, the diverge-or-reply rule for $\sigma$ and $\tau$ gives us a divergence at $s$ in $\sigma;\tau$.  
  In the second case, an infinite chattering between $\sigma$ and $\tau$ corresponds to an infinite interaction $\s\in\Int(A,B,C)$ ending with infinitely many moves in $B$ such that $\s\vert_{A,C}=s$. 
  Completeness for $\sigma$ and $\tau$ tells us that $\s\vert_{A,B}\in D_\sigma$ and $\s\vert_{B,C}\in D_\tau$ and therefore that $\s\vert_{A,C}\in D_{\sigma;\tau}$.  
\end{proof}

Our proof for Corollary \ref{cor:diverge-or-reply} really makes use of the fact that a locally complete strategy is \emph{lively} in the sense of \cite{LevyGsInfinite}; i.e., locally deterministic.  
Our definition is slightly stronger than liveliness, because it insists that the union of complete strategies be \emph{countable}.  
This will be essential to our definability result.

\subsubsection{Associativity of composition}

In fact, the proof of associativity of composition is pretty much the same in our model as it is in any other model of game semantics.  
However, it is worth saying a few words about it, since the model obtained by naively extending the Harmer-McCusker model to unbounded nondeterminism does not have an associative composition.  
The point is that this is not really a problem with associativity, but rather that this naive model gives the wrong result for the composition of strategies.  
For example, if $\nu$ is the strategy we defined above, and $\0$ is the `constant $0$' strategy on $\bN$, then $\0;\nu$ has a divergence in the naive model, because the strategies $\0$ and $\nu$ appear to be engaged in infinite chattering.  
In our model, we have fixed that problem, because the strategy $\nu$ contains no infinite plays, and so no divergences arise in the composition.

\subsection{A symmetric monoidal closed category}

Given a game $A$, we define a strategy $\id_A$ on $A\implies A$, where $T_{\id_A}$ is given by
\[
  \{s\in P_{A_1\implies A_2}\suchthat\textrm{for all even-length }t\prefix s,\;t\vert_{A_1}=t\vert_{A_2}\}\,,
  \]
where we distinguish between the two copies of $A$ by calling them $A_1$ and $A_2$, and where $D_\sigma$ is the set of all infinite plays in $T_\sigma$.
This is an identity for the composition we have defined, and so we get a category $\G_{ND}$ of games and nondeterministic strategies.
Moreover, the connectives $\tensor$ and $\implies$ exhibit $\G_{ND}$ as a symmetric monoidal closed category.  

$\G_{ND}$ has an important subcategory $\G_D$ of deterministic complete strategies; this category is isomorphic to the category considered in \cite{SamsonGuyIAPassive}.

\subsection{Products and Exponentials}

Let $A, B$ be games
We define a new game $A \times B$.  
The arena for $A\times B$ is the same as the arena for $A\tensor B$, but now $P_{A\times B}$ is the disjoint union of $P_A$ and $P_B$ inside that arena:
\begin{IEEEeqnarray*}{RCL}
  P_{A \times B} & = & \{s\in L_{A\tensor B}\suchthat s\vert_A \in P_A\text{ and }s\vert_B=\emptyplay\} \\
  & \cup & \{s\in L_{A\tensor B}\suchthat s\vert_A=\emptyplay\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}
Then $A\times B$ is the category-theoretic product of $A$ and $B$ in $\G_{ND}$.

We define a game $\oc A$ as follows.  
The arena for $\oc A$ is the same as the arena for $A$, but the set of plays is given by
\[
  P_{\oc A} = \{s\in L_A\suchthat s\vert_m\in P_A\text{ for each initial move $m$}\}\,.
  \]
There are strategies $\mult_A\from \oc A \to \oc A \tensor \oc A$, $\mathsf{coh}\from \oc (A\times B) \toisom \oc A \tensor \oc B$ and $\der_A\from \oc A \to A$ that can be used to create a Cartesian closed category $\G^\oc_{ND}$, in which morphisms from $A$ to $B$ are strategies for the game $\oc A\implies B$.  
This construction is essentially the co-Kleisli category on a comonad given by $\oc$, but certain technical issues prevent us from presenting it in this way.
See \cite{SamsonGuyIAPassive} for full details.

\subsection{Constraining strategies}

Given a non-empty justified string $s$ in an arena $A$, we define the \emph{$P$-view} $\pv s$ of $s$ inductively as follows.
\begin{IEEEeqnarray*}{rClCR}
  \pv{sm} & = & m\,, &\qquad& \text{if $m$ is initial;} \\
  \pv{sntm} & = & \pv s n m\,, && \text{if $m$ is an $O$-move and} \\
  &&&&\text{$n$ justifies $m$;} \\
  \pv{sm} & = & \pv s m\,, && \text{if $m$ is a $P$-move.}
\end{IEEEeqnarray*}

We say that a play $sm$ ending in a $P$-move is \emph{$P$-visible} if the justifier of $m$ is contained in $\pv{m}$.  
We say that a strategy $\sigma$ for a game $A$ is \emph{visible} if every $P$-position $s\in T_\sigma$ is $P$-visible.
It can be shown that the composition of visible strategies is visible, and that we can build a Cartesian closed category using our exponential.  

The resulting category $\G^\oc_{D,vis}$ of games and deterministic visible strategies is a fully abstract model of Idealized Algol \cite{SamsonGuyIAPassive}.

\subsection{Recursive games and strategies}

Most full abstraction results go via a definability result that says that all \emph{compact} strategies are definable \cite{curienFullAbstraction}.
However, deducing full abstraction from compact definability makes essential use of continuity properties that are absent when we deal with countable nondeterminism.  
We will therefore need to appeal to a stronger result -- that of \emph{universality}, which states that \emph{every} strategy is definable.  
Clearly, universality does not hold for any of our categories of games, since there are many non-computable functions $\bN\to\bN$.  
However, Hyland and Ong proved in \cite{hoPcf} that every \emph{recursively presentable} innocent strategy is PCF-definable.  

In order to define recursively presentable strategies, we need to work with \emph{enumerated games}; i.e., games where the set of moves comes with an enumeration to the natural numbers.  
Clearly our base games $\bN$ and $\bC$ can be enumerated, as can the tensor product, linear implication, exponential and product of games.  

\begin{proposition}
  Let $\G_{D,vis,rec}$ be the category of games and \emph{recursive} visible strategies.  
  Then $\G_{D,vis,rec}$ is a fully abstract model of Idealized Algol in which every morphism is definable.
\end{proposition}
\begin{proof}
  This follows from the corresponding results for PCF, together with the \emph{innocent factorization} result of \cite{SamsonGuyIAPassive}.  
  See also \cite{MurawskiUniversality}.
\end{proof}

\subsection{Deterministic Factorization}

Our definability results will hinge on a \emph{factorization theorem}, showing that every nondeterministic strategy may be written as the composition of a deterministic strategy with the nondeterministic `oracle' $\top_{\bN}$.  
We can then deduce definability from definability in the model of deterministic Idealized Algol.

Note that our result is a bit simpler than the corresponding result in \cite{mcCHFiniteND}; this is because it is easier to model a countable source of nondeterminism than a `finite but arbitrarily large' source.

\begin{proposition}
  Let $\sigma\from I \to A$ be a strategy for a game $A$ in $\G_{ND}$.
  Then we may write $\sigma$ as $\top_{\bN};\Det(\sigma)$, where $\Det(\sigma)\from \oc\bN\to A$ is a deterministic strategy and $\top_{\bN}$ is the strategy for $\oc\bN$ given by
  \begin{itemize}
    \item $T_{\top_{\bN}}=P_{\oc\bN}$.
    \item $D_{\top_{\bN}}$ is the set of infinite positions in $T_{\top_\bN}$.
  \end{itemize}
\end{proposition}

\begin{proof}
  We begin by fixing an injection $\code_A$ from the set of $P$-moves in $A$ into the natural numbers.  
  In the enumerated case, this is given to us already.
  
  We first assume that the strategy $\sigma$ is complete.
  Then the strategy $\Det(\sigma)$ is very easy to describe.  
  For each $O$-position $sa\in T_\sigma$, we have some set $B$ of possible replies to $sa$, which we order as $b_1,b_2,\cdots$, where $\code_A(b_1)<\code_A(b_2)<\cdots$.  
  We insert a request to the oracle for a natural number; then, depending on her answer $j$, we play the next move as follows:
  \begin{itemize}
    \item If $0 < j \le \code_A(b_1)$, then play $b_1$.
    \item If $\code_A(b_n) < j \le \code_A(b_{n+1})$ then play $b_{n+1}$.
    \item If $j = 0$ and $sa\in D_\sigma$, then play nothing, and put the resulting play inside $D_{\Det(\sigma)}$.  
      Otherwise, play $b_1$.
  \end{itemize}
  Lastly, we close under limits to make the strategy $\Det(\sigma)$ complete.  
  $\Det(\sigma)$ is clearly nondeterministic.  
  Checking that $\top_{\bN};\Det(\sigma)=\sigma$ is easy for finite plays; for infinite plays, it follows by completeness of $\sigma$.

  Lastly, if $\sigma$ is the union of complete strategies $\sigma_1,\sigma_2,\cdots$, we insert an additional request to the oracle immediately after the very first move by player $O$; after receiving a reply $k$, we play according to $\sigma_k$.
\end{proof}

Note that in the recursive case, $\Det(\sigma)$ is clearly recursively presentable if $\sigma$ is.  
Furthermore, if $\sigma$ is visible, then so is $\Det(\sigma)$.

\section{Full abstraction}

\subsection{Denotational Semantics}

The category in which we shall model our language is the category $\G_{ND,vis,rec}^\oc$ -- the Cartesian closed category of (enumerated) games with nondeterministic, recursively presentable visible strategies.  
We have a natural embedding $\G_{D,vis,rec}^\oc\hookrightarrow\G_{ND,vis,rec}^\oc$, and we know that $\G_{D,vis,rec}^\oc$ is a universal and fully abstract model of Idealized Algol.

Any term $M\from T$ of Idealized Algol with countable nondeterminism may be written as $M = C[\wn]$, where $C$ is a context not involving the constant $\wn$.  
Then the term $\lambda n.C[n]$ is a term of Idealized Algol, and therefore has a denotation $\oc\bN \to \deno{T}$ as in \cite{SamsonGuyIAPassive}.
We define the denotation of $M$ to be given by the composite
\[
  I \xrightarrow{\top_{\bN}}
  \oc \bN \xrightarrow{\deno{\lambda n.C[n]}}
  \deno{T}
  \]
In other words, we interpret the constant $\wn$ using the strategy $\top_{\bN}$ for $\bN$.

\subsection{Adequacy and soundness}

We prove a \emph{consistency} result for our model.  
Let $M$ be a closed term of type $\com$.

\begin{lemma}
  If $M\converges\skipp$ then $qa\in T_{\deno M}$.  
  If $M\mustconverge$ then $D_{\deno M}=\emptyset$.
  \label{lem:consistency}
\end{lemma}

We can also prove the converse, \emph{computational adequacy}.

\begin{proposition}
  If $qa\in T_{\deno M}$ then $M\converges\skipp$.
  If $D_{\deno M}=\emptyset$ then $M\mustconverge$.
  \label{prop:adequacy}
\end{proposition}

Traditional proofs of computational adequacy using logical relations make essential use of the continuity of composition with respect to a natural ordering on strategies (see, for example, \cite{mcCHFiniteND} and \cite{RusssThesis} for the finite nondeterminism case).  
In our case, since composition is not continuous in the language itself, we cannot use this technique.
In order to prove soundness and adequacy, we use a new technique that involves using a deterministic stateful construction to model the nondeterminism inside a deterministic world in which continuity holds.  
We shall return to the concept of an \emph{evaluation} of a term as a sequence of natural numbers that we use to replace the constant $\wn$.  

\begin{lemma}
  Let $M=C[\wn]$ be a term of type $\com$.  
  Write $\sigma_M$ for the denotation of the term $\lambda n.C[n]$.  
  \begin{itemize}
    \item $M\converges\skipp$ if and only if there exists some total deterministic strategy $\sigma\from\oc\bN$ such that $qa\in T_{\sigma;\sigma_M}$.
    \item $M\not{\mustconverge}$ if and only if there exists some total deterministic strategy $\sigma\from\oc\bN$ such that $D_{\sigma;\sigma_M}\ne\emptyset$.
  \end{itemize}
  \label{lem:soundness-lemma}
\end{lemma}

\begin{proof}
  We prove the forward directions first.

  Let $n_1,\dots,n_k,d$ be a finite sequence of natural numbers.  
  We define an Idealized Algol term $N_{n_1,\dots,n_k,d}\from (\nat \to \com) \to \com$ to be the following.
  \[
    \lambda f.\new_\nat (\lambda v.f(v\coloneqq (suc\;\deref v); \case_{k+1}\;\deref v\;\Omega\;n_1 \cdots n_k d))\,.
    \]
  Here, $\case_{k+1}\;a\;n_0\;\cdots\;n_k\;d$ evaluates to $n_i$ if $a$ evaluates to $i$, and evaluates to $d$ if $a$ evaluates to $j> k$.
  Clearly, it can be built out of $\IfO$s.
  This term adds an extra variable $v$ to the program; each time $f$ is called, it increments the value of $v$ and maps its value on to one of the $n_i$.  

  Now let $\pi$ be a finite evaluation of $\ia s {C[\wn]} \converges\skipp$.  
  Encode $\pi$ as a sequence $n_1,\dots,n_k$.  
  Let $d$ be some arbitrary number.
  Then we can show that the following term also converges to $\skipp$ in the same way:
  \[
    N_{n_1,\dots,n_k,d} (\lambda n.C[n])\,.
    \]
  The idea here is similar to one used in testing; we want to test the behaviour of a nondeterministic program, and to do so we \emph{mock} the random number generator in order to simulate a particular evaluation path using purely deterministic programs.  

  If instead $\pi$ is a finite evaluation of $\ia s {C[\wn]}\not\mustconverge$; i.e., a divergent evaluation (that nevertheless only involves finitely many calls to the nondeterministic oracle), then the term $N_{n_1,\dots,n_k,d} (\lambda n.C[n])$ will diverge according to the same execution path.

  Digging into the construction of $\new$ within Idealized Algol, as given in \cite{SamsonGuyIAPassive}, we see that for any term $F$ of type $\nat\to\com$ the denotation of $N_{n_1,\dots,n_k,d} F$ is given by the composite
  \[
    I \xrightarrow{\cell_{0}}
    \oc \Var \xrightarrow{\deno{\lambda v.v\coloneqq (\suc\;\deref v);\case_{k+1}\;\deref v\;\Omega\;n_1\cdots n_k d}}
    \oc\bN \xrightarrow{\deno F}
    \bC\,.
    \]
  We set $\sigma_\pi$ to be the composite of the left two arrows.  
  Observe that $\sigma_\pi$ is the strategy with unique maximal infinite play as follows.
  \[
    q\;n_1\;\cdots\;q\;n_k\;q\;d\;q\;d\;\cdots
    \]
  Setting $F = \lambda n.C[n]$, we see that $\deno{F}=\sigma_M$.  
  So, by soundness and adequacy for the Idealized Algol model, we see that $qa\in T_{\sigma_\pi;\sigma_M}$ if and only if $N_{n_1,\dots,n_k,d} (\lambda n.C[n])\converges\skipp$, which is the case if and only if $M\converges\skipp$ along the evaluation $\pi$.
  Similarly, $D_{\sigma_\pi;\sigma_M}\neq\emptyset$ if and only if $N_{n_1,\dots,n_k,d}(\lambda n.C[n])$ diverges, which is equivalent to saying that $M$ diverges along the evaluation $\pi$.

  Lastly, we need to deal with the case that there is an infinite evaluation $\pi = n_1,n_2,\dots$ of $M$ that consults the nondeterministic oracle infinitely often.
  In this case, $M$ must certainly diverge along the evaluation $\pi$.
  For each $j$, we define $\pi_n^{(j)}$ to be the strategy for $\oc N$ corresponding to the term $N_{n_1,\dots,n_j,\Omega}$.  
  So $\pi_n^{(j)}$ has a unique finite maximal play
  \[
    q\;n_1\;q\;n_2\;\cdots\;q\;n_j\;q\,,
    \]
  at which point the strategy has a partiality.  

  Evaluation of the term $N_{n_1,\dots,n_j,\Omega} (\lambda n.C[n])$ must diverge, since it will proceed according to the evaluation $\pi$ and eventually reach the divergence (since $\pi$ consults the oracle infinitely often).  
  This implies that $D_{\sigma_\pi^{(j)};\sigma_M}\ne\emptyset$ for all $j$.

  We define $\sigma_\pi$ to be the least upper bound of the $\sigma_\pi^{(j)}$ (e.g., in the sense of \cite{mcCHFiniteND}).  
  Since composition is continuous for deterministic (!) strategies, we deduce that $D_{\sigma_\pi;\sigma_M}\ne\emptyset$.

  $\sigma_\pi$ has plays of the form
  \[
    q\;n_1\;q\;n_2\;\cdots\,,
    \]
  and so it is total.

  We now prove the reverse implications.  
  Let $\sigma\from\bN$ be a total deterministic strategy for $\oc\bN$.
  Then $\sigma$ must have a maximal infinite play $s_\sigma$ of the form
  \[
    q\;m_1\;q\;n_2\;\cdots\,,
    \]
  where $m_1,m_2,\dots$ is some infinite sequence of natural numbers.  
  If the strategy $\sigma_M$ contains some play $\s$ such that $\s\vert_{\oc\bN}=s$, then $\sigma=\sigma_\pi$ for some infinite evaluation $\pi$ of $M$.  
  Otherwise, let $t$ be the maximal sub-play of $s$ such that $\s\vert_{\oc\bN}=t$ for some $\s\in\sigma_M$.  
  Then, if we replace $\sigma$ with the strategy $\sigma'$ that plays according to $t$ and subsequently plays $q\;d\;q\;d\;\cdots$ for our fixed value $d$, then we will have $\sigma';\sigma_M=\sigma;\sigma_M$.  
  Moreover, $\sigma'=\sigma_\pi$ for some evaluation $\pi$ of $M$.

  Now suppose that there exists $\sigma\from\oc\bN$ such that $qa\in T_{\sigma;\sigma_M}$.  
  By the above discussion, we may assume that $\sigma=\sigma_\pi$ for some evaluation $\pi$ of $M$.  
  Therefore, $qa\in T_{\sigma_\pi;\sigma_M}$, which means that $M\converges\skipp$ along the evaluation $\pi$.  
  The corresponding statement for must convergence follows in the same way.
\end{proof}

We can now prove our soundness and adequacy results.

\begin{proof}[Proof of Lemma \ref{lem:consistency}]
  Suppose that that $M$ is a closed term of type $\com$ and that $M\converges\skipp$.  
  Then $qa\in T_{\sigma;\sigma_M}$ for some strategy $\sigma$.  
  It follows that $qa\in T_{\top_\bN;\sigma_M}$.

  Now suppose that $D_{\deno M}\neq\emptyset$.  
  Then there is some interaction $\s\in\Int_\infty(I,\oc\bN,\bC)$ such that $\s\vert_\bC\in D_{\sigma_M}$.
  Let $\sigma$ be a deterministic total strategy containing $\s\vert_{\oc\bN}$.  
  Then we have $D_{\sigma;\sigma_M}\ne\emptyset$, so $M$ diverges by Lemma \ref{lem:soundness-lemma}.
\end{proof}

\begin{proof}[Proof of Proposition \ref{prop:adequacy}]
  Suppose that $M$ is a closed term of type $\com$ and that $qa\in T_{\deno M}$.  
  Then there is some interaction $\s\in\Int_\infty(I,\oc\bN,\bC)$ such that $qa\in\s\vert_\bC$.  
  Let $\sigma$ be a deterministic total strategy for $\oc\bN$ containing the play $\s\vert_{\oc\bN}$.  
  Then we have $qa\in T_{\sigma;\sigma_M}$, so $M\converges\skipp$ by Lemma \ref{lem:soundness-lemma}.

  Now suppose that $M\not\mustconverge$.  
  Then we have $D_{\sigma;\sigma_M}\ne\emptyset$ for some strategy $\sigma\from\oc\bN$.
  Moreover, since $\sigma_\pi$ is total, it follows that $D_{\top_{\bN};\sigma_M}\ne\emptyset$.
\end{proof}

We define \emph{extensional equivalence of strategies} as follows.  
If $\sigma,\tau$ are two strategies for a game $A$, we say that $\sigma\oes\tau$ if for all test morphisms $\alpha\from A \to \bC$ we have $\sigma;\alpha=\tau;\alpha$.  
Having defined this equivalence, we may prove \emph{soundness} in the usual way.

\begin{theorem}[Soundness]
  Let $M,N$ be two closed terms of type $T$.  
  If $\deno{M}\oes\deno{N}$ then $M\emam N$.  
\end{theorem}

\subsection{Universality}

Let $S,T$ be Idealized Algol types and let $\sigma\from S\to T$ be a morphism in $\G_{ND,vis,rec}^\oc$.  
We want to prove that $\sigma$ is the denotation of some term.  

By our nondeterministic factorization result, we know that $\sigma=\top_\bN;\Det(\sigma)$, where $\Det(\sigma)$ is a deterministic strategy.  
By universality for $\G_{D,vis,rec}^\oc$, we know that $\Det(\sigma)=\deno{M}$ for some closed term $M\from S \to T$.  
Then $\sigma=\top_\bN;\Det(\sigma)=\deno{\wn};\deno M = \deno{M\;\wn}$.

\subsection{Full abstraction}

\begin{theorem}[Full abstraction]
  Let $M,N$ be two closed terms of type $T$.  
  If $M\emam N$ then $\deno{M}\oes\deno{N}$.  
\end{theorem}
\begin{proof}
  Let $A=\deno T$.  
  Suppose that $\deno{M}\not{\oes}\deno{N}$; so there is some strategy $\alpha\from A\to\bC$ such that $\deno{M};\alpha\ne\deno{N};\alpha$.  
  By universality, we have $A=\deno{P}$ for some closed term $P$ of type $T\to\com$.  
  Then we have $\deno{M};\deno{P}\ne\deno{N};\deno{P}$; by consistency and adequacy, it follows that $M\not{\emam} N$.
\end{proof}

\section{Nondeterministic PCF}

We conclude by saying a few remarks about the situation when our base deterministic language is PCF rather than Idealized Algol.  
Tsukada and Ong \cite{TsukadaSheaves} showed that traditional game semantics models are unsuitable for modelling this language: while the definition of \emph{visibility} of strategies can be extended to nondeterministic strategies without difficulty, the corresponding definition for PCF -- that of an \emph{innocent} strategy -- does not.  
Tsukada and Ong instead use a new type of game semantics in which strategies are given not by sets of plays but by justified \emph{trees} whose vertices are moves.  
The difference is subtle but important: from the point of view of countable nondeterminism it allows us to distinguish between terms that take an arbitrarily large finite number of steps to converge and terms that diverge.  
For example, the denotation of our term $M$ above has an infinite branch in it, while the denotation of $N$ has infinitely many finite branches of arbitrary length.  

The main advantage of the tree-based model, however, is that it gives rise to a satisfactory synthetic definition of a \emph{nondeterministic innocent} strategy based on sheaves.  
In fact, Tsukada and Ong do not prove full abstraction for PCF with countable nondeterminism (even though that language may be interpreted within their category), but for PCF with finite nondeterminism.  

Having ourselves given a fully abstract model of Idealized Algol with countable nondeterminism, we shall contribute to the process of `completing the square' by giving a sketch of how we can use our techniques to prove soundness and adequacy for the Tsukada-Ong model of PCF with countable nondeterminism.  
A side-effect of this will be to give an alternative proof of soundness and adequacy for their model of PCF with finite nondeterminism.  

The first observation to make is that our Lemma \ref{lem:soundness-lemma} is not really a statement about the category $\G_{ND,vis}$, but one about the deterministic model $\G_{D,vis}$.  

For example, the first part of the lemma says that if $C[-]$ is an ordinary deterministic Idealized Algol context, then $C[\wn]\converges\skipp$ if and only if there exists some total deterministic strategy $\sigma\from\oc\bN$ such that $qa\in T_{\sigma;\deno{\lambda n.C[n]}}$.  
Although we have mentioned a term ($C[\wn]$) living in nondeterministic Idealized Algol, this can be thought of as a statement about $C[-]$ itself, which is part of deterministic Idealized Algol.  
Moreover, the strategy $\sigma$ and the denotation of $\lambda n.C[n]$ are both deterministic strategies, so we can interpret Lemma \ref{lem:soundness-lemma} as telling us something about Idealized Algol and its game semantics.  
We can therefore forget about our nondeterminism model, with its divergence sets and infinite plays (neither of which are part of the Tsukada-Ong model) and concentrate on the Abramsky-McCusker model of Idealized Algol.
Note that although Lemma \ref{lem:soundness-lemma} mentions $T_{\sigma;\sigma_M}$ and $D_{\sigma;\sigma_M}$, we can rephrase both of these inside the deterministic model, since the strategies involved are both deterministic.  

We want a version of Lemma \ref{lem:soundness-lemma} that can be applied to PCF contexts and the game semantics model $\G_{inn}$ of PCF.  
Clearly, the lemma as currently stated does not hold in $\G_{inn}$, since the strategies $\sigma$ that we define are not innocent in general.  

Instead, we need to look at the combinatorial structure of the strategies.  
We observe that if $\sigma_M\from\oc\bN\to\bC$ is a strategy, then there exists a deterministic strategy $\sigma\from\oc\bN$ such that $qa\in T_{\sigma;\sigma_M}$ if and only if there exists some $\s\in T_{\sigma_M}$ such that $\s\vert_{\bC}=qa$.  
In addition, there exists a deterministic strategy $\sigma\from\oc\bN$ such that $D_{\sigma;\sigma_M}\ne\emptyset$ if and only if $\sigma_M$ is not \emph{winning}; i.e., either $\sigma_M$ is not total or there exists some $\s\in T_{\sigma_M}$ with an infinite tail of moves in $\oc\bN$.  
We recover the following version of Lemma \ref{lem:soundness-lemma} which now applies to the interpretation of PCF in $\G_{inn}$:
\begin{lemma}
  Let $M=C[\wn]$ be a term of type $\com$.  
  Write $\sigma_M\from\oc\bN\to\bC$ for the denotation of the term $\lambda n.C[n]$.  
  \begin{itemize}
    \item $M\converges\skipp$ if and only if there exists $\s\in \sigma_M$ such that $\s\vert_{\bC}=qa$.  
    \item $M\mustconverge$ if and only if $\sigma_M$ is \emph{winning}.
  \end{itemize}
  \label{lem:pcf-soundness-lemma}
\end{lemma}

Now we have an inclusion functor $\G_{inn}\hookrightarrow\G_{TO}$, where $\G_{TO}$ is the Tsukada-Ong category.  
Since the nondeterministic oracle $\wn$ may also be interpreted as a tree-strategy $\top_{\bN}$ in $\G_{TO}$, this gives us a model of PCF with countable nondeterminism inside that category.  

It is then possible to deduce versions of Lemma \ref{lem:consistency} and Proposition \ref{prop:adequacy} from Lemma \ref{lem:pcf-soundness-lemma} as we did above for our model of Idealized Algol, using the details of the inclusion functor from $\G_{inn}$ and the definition of composition in $\G_{TO}$.  
We can then deduce soundness in the usual way.

It is worth noting an alternative line of attack, which is to first build a copy of our model of Idealized Algol with countable nondeterminism inside $\G_{TO}$, using our argument to prove soundness and adequacy, and then restrict down to nondeterministic PCF.
The approach above is more general, however, since it does not make use of the fact that Idealized Algol may be interpreted in $\G_{TO}$.

%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{../../common/phd_bibliography}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
