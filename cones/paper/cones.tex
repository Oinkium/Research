%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,10pt,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[sigplan,10pt]{acmart}\settopmatter{}


%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmConference[LICS'18]{ACM/IEEE Symposium on Logic in Computer Science}{9-12 July, 2018}{Oxford, UK}
\acmYear{2018}
\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2017}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
%\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
%\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\let\NOTARTICLE=1
\let\FEWFONTS=1
\let\BEAMER=1
\let\G\undefined
\let\C\undefined
\let\W\undefined
\let\U\undefined
\let\E\undefined
\input{../../common/preamble}
\renewcommand{\dv}{{\lightning}}
\newcommand{\oracle}{{\textsf{oracle}}}


\begin{document}

%% Title information
\title[Short Title]{Full Title}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
\subtitle{Subtitle}                     %% \subtitle is optional
\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{W. J. Gowers}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{0000-0002-4513-9618}             %% \orcid is optional
\affiliation{
  \position{PhD Student}
  \department{Department of Computer Science}              %% \department is recommended
  \institution{University of Bath}            %% \institution is required
  \streetaddress{Claverton Down Road}
  \city{Bath}
  \postcode{BA2 7QY}
  \country{United Kingdom}                    %% \country is recommended
}
\email{W.J.Gowers@bath.ac.uk}

%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10003752.10010124.10010131.10010133</concept_id>
<concept_desc>Theory of computation~Denotational semantics</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[300]{Theory of computation~Denotational semantics}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

Text of paper \ldots

\section{Idealized Algol with Countable Nondeterminism}

The language that we will be modelling is the language Idealized Algol \cite{SamsonGuyIAPassive}, extended with an additional constant $\wn$ representing countable nondeterminism.  
This is similar to the approach adopted in \cite{mcCHFiniteND}, which extends Idealized Algol with \emph{finite} nondeterminism.  
The types of the language are defined inductively as follows:
\[
  T \Coloneqq \nat \mid \com \mid \Var \mid T \to T\,.
  \]
Meanwhile, the terms are those given in \cite{SamsonGuyIAPassive}, together with the nondeterministic choice:
\begin{IEEEeqnarray*}{RCL}
  M & \Coloneqq & x \mid \lambda x . M \mid M\;M \mid \Y_T M \mid \\
  && \n \mid \skipp \mid \suc M \mid \pred M \mid \\
  && \IfO M\;M\;M \mid M;M \mid \\
  && M \coloneqq M \mid \deref M \mid \\
  && \neww_T\;M \mid \mkvar M\;M \mid \wn\,.
\end{IEEEeqnarray*}

The typing rule for $\wn$ is $\Gamma \vdash \wn\from\nat$.
We shall use the letter $v$ to range over variables of type $\Var$.  

The value forms in the language are given by
\[
  V \Coloneqq \skipp \mid \n \mid \lambda x.M \mid v \mid \mkvar
  \]
We define predicates $M \converges V$ ($M$ may converge to $V$) and $M\mustconverge$ ($M$ must converge) inductively to give a big-step operational semantics for our language.  
We give a selection of the appropriate rules in Figure \ref{fig:ia-os}; this presentation is almost identical to that given in \cite{mcCHFiniteND}, with a slightly different rule for the countable nondeterminism.  
In each rule, $\ia{s}{M}$ is a \emph{configuration} of the language, where $M$ is a term, and $s$ is a \emph{store}; i.e., a function from the set of variables free in $M$ to the set of natural numbers.  
If $s$ is a store and $v$ a variable, we write $\stup s v n$ for the state formed by updating the value of the variable $v$ to $n$.

\begin{figure*}
  \begin{mathpar}
    \inferrule*{\ia s N \converges \ia {s'} \n \\ \ia {s'} M \converges \ia {s''} v}
    {\ia s {M \coloneqq N} \converges \ia {\stup {s''} v n} \skipp}
    \and
    \inferrule*[right=${s'(v) = n}$]{\ia s M \converges \ia {s'} v}
    {\ia s {\deref M} \converges \ia {s'} \n}
    \and
    \inferrule*{\ia s M \converges \ia {s'} \skipp \\ \ia {s'} N \converges \ia {s''} V}
    {\ia s {M;N} \converges \ia {s''} V}
    \and
    \inferrule*{\ia {\stup s v 0} M \converges \ia {\stup{s'} v n} V}
    {\ia s {\new_T\;\lambda v.M} \converges \ia {s'} V}
    \and
    \inferrule*[right=$n\in\bN$]{\ia s {M \n} \converges \ia {s'} V}
    {\ia s {M \wn} \converges \ia {s'} V}
    \and
    \inferrule*{\forall n\in\bN.\ia s {M \n}\mustconverge}
    {\ia s {M \wn} \mustconverge}
    \and
    \inferrule*{\ia s M \mustconverge \\ \forall \ia {s'} {\lambda x.M'}\esuchthat \ia s M \converges \ia {s'} {\lambda x.M'} \Rightarrow \ia {s'}{M'[N/x]}\mustconverge}
    {\ia s {M\;N}\mustconverge}
  \end{mathpar}
  \caption{Operational semantics of Idealized Algol with Countable Nondeterminism}
  \label{fig:ia-os}
\end{figure*}

Given a term $M$ of ground type $\com$ or $\nat$, a proof $\pi$ that $\ia s M\converges V$ gives rise to a (possibly infinite) sequence of natural numbers corresponding to a bottom-to-top, left-to-right reading of the natural numbers $n$ used in the first rule for $\wn$.  
We call such a sequence an \emph{evaluation} of the configuration $\ia s M$.  
It is perhaps easier to view this from the perspective of a small-step reduction: the sequence of numbers is formed by listing the different values that the nondeterminism constant $\wn$ decays to over the course of the evaluation $\pi$.  

Let $T$ be an Idealized Algol type, and let $M,N\from T$ be terms.  
Then we write $M\lmam N$ if for all compatible contexts $C[-]$ of ground type we have
\begin{gather*}
  C[M]\converges V \Rightarrow C[N] \converges V\\
  C[M]\mustconverge \Rightarrow C[N] \mustconverge
\end{gather*}

We write $M\emam N$ if $M\lmam N$ and $N\lmam M$.

One aspect of the language that makes it particularly difficult to model is that function application is not continuous, either with respect to functions or with respect to arguments.  

For example, it is easy to write a sequence of functions ${<}\!n \from \nat \to \nat$ that return $0$ if their argument is less than $n$ and diverge otherwise:

\begin{align*}
  &{<}0 = \lambda m.\Omega \\
  &{<}1 = \lambda m.\IfO m\;\0\;\Omega \\
  &{<}2 = \lambda m.\IfO m\;\0\;(\IfO (\pred m)\;\0\;\Omega)\\
  \cdots
\end{align*}
It is easy enough to see (for example, by the denotational semantics) that the least upper bound of these functions is the function $\lambda x.\0$.  
However, it is clear that ${<}n\;\wn\not\mustconverge$ for each $n$, while $\lambda x.\0\;\wn$ must converge to $\0$.  
Thus, $\lambda x.\0\;\wn$ is not the least upper bound of the ${<}n\;\wn$.

This is a bit of a problem, since continuity often plays an important role in full abstraction proofs -- firstly, for proving Computational Adequacy of the recursion combinator, and, secondly, for deducing full abstraction from compact definability.  
Semantically, we shall deal with the first problem by adopting a novel approach to Computational Adequacy, and with the second problem by appealing to the stronger \emph{universality} result: namely, that every \emph{recursive} strategy is definable.

\section{Game Semantics}

We will use the Hyland-Ong version of Game Semantics, as in \cite{SamsonGuyIAPassive}.

\subsection{Arenas}

An \emph{arena} is given by a triple $A=(M_A,\lambda_A,\ts_A)$, where
\begin{itemize}
  \item $M_A$ is a countable set of moves,
  \item $\lambda_A\from m_A\to\OP\times\QA$ designates each move as either an \emph{$O$-move} or a \emph{$P$-move}, and as either a \emph{question} or an \emph{answer}.  
    We define $\lambda_A^{OP}=\pr_1\circ\lambda_A$ and $\lambda_A^{QA}=\pr_2\circ\lambda_A$.  
    We also define $\neg\from\OP\times\QA\to\OP\times\QA$ to be the function that reverses the values of $O$ and $P$ while leaving $\QA$ unchanged.
  \item $\ts_A$ is an \emph{enabling relation} between $M_A+\{*\}$ and $M_A$ satisfying the following rules:
    \begin{itemize}
      \item If $a\ts_A b$ and $a\ne b$, then $\lambda_A^{OP}(a)\neq\lambda_A^{OP}(b)$.  
      \item If $*\ts_A a$, then $\lambda_A(a)=OQ$ and $b\nts_A a$ for all $b\in M_A$.
      \item If $a\ts_A b$ and $b$ is an answer, then $a$ is a question.
    \end{itemize}
    We say that a move $a\in M_A$ is \emph{initial} in $A$ if $*\ts_A a$.
\end{itemize}

Our base arenas will be the \emph{flat arenas} for the types $\nat$ and $\com$.  
Given a set $X$, the flat arena on $X$ is the arena with a single $O$-question $q$ and a $P$-answer $x$ for each $x\in X$, where $*\ts q$ and $q\ts x$ for each $x$.  
The denotation of the type $\nat$ will be the flat arena $\bN$ on the set of natural numbers, while the denotation of the type $\com$ will be the flat arena $\bC$ on the singleton set $\{a\}$.

Given an arena $A$, a \emph{justified string} in $A$ is a sequence $s$ of moves in $A$, together with \emph{justification pointers} that go from move to move in the sequence in such a way that every non-initial move $m$ in $s$ has exactly one justification pointer going back to an earlier move $n$ in $s$ such that $n\ts_A m$.  
We say that $n$ \emph{justifies} $m$.  
It is easy to see that every justified string must begin with an initial move, an hence with an $O$-question.  

A \emph{legal play} $s$ is a justified string in $A$ that strictly alternates between $O$-moves and $P$-moves and is such that the corresponding $QA$-sequence formed by applying $\lambda_A^{QA}$ to terms is well-bracketed.
We write $L_A$ for the set of legal plays in $A$.

\subsection{Games and strategies}

We follow the approach taken by Abramsky and McCusker \cite{SamsonGuyIAPassive} -- a middle road between the \emph{arenas} of Hyland and Ong and the \emph{games} of \cite{ajmPcf} that makes the linear structure more apparent.

Let $s$ be a legal play in some arena $A$.  
If $m$ and $n$ are moves in $s$ such that there is a chain of justification pointers leading from $m$ back to $n$, we say that $n$ \emph{hereditarily justifies} $m$.  
Given some set $S$ of initial moves in $s$, we write $s\vert_S$ for the subsequence of $s$ made up of all those moves that are hereditarily justified by some move in $S$.

A \emph{game} is a tuple $A=(M_A,\lambda_A,\ts_A,P_A)$, where $(M_A,\lambda_A,\ts_A)$ is an arena and $P_A$ is a non-empty prefix-closed set of legal plays in that arena such that if $s\in P_A$ and $I$ is a non-empty set of initial moves in $s$, then $s\vert_I\in P_A$.

\subsubsection{Multiplicatives}

Let $A,B$ be games.  
We define games $A\tensor B$ and $A\implies B$ as follows.
\begin{IEEEeqnarray*}{RCL}
  M_{A\tensor B} & \quad=\quad & M_A + M_B\,. \\
  \lambda_{A\tensor B} & = & [\lambda_A,\lambda_B]\,.\\
  *\ts_{A\tensor B} n & \Leftrightarrow & * \ts_A n \text{ or } * \ts_B n\,. \\
  m \ts_{A\tensor B} n & \Leftrightarrow & m \ts_A n\text{ or } m \ts_B n\,.\\
  P_{A\tensor B} & = & \{s\in L_{A\tensor B}\suchthat s\vert_A\in P_A\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}
\begin{IEEEeqnarray*}{RCL}
  M_{A\implies B} & \quad=\quad & M_A + M_B\,. \\
  \lambda_{A\implies B} & = & [\neg\circ\lambda_A,\lambda_B]\,.\\
  *\ts_{A\implies B} n & \Leftrightarrow & * \ts_B m\,.\\[1.0ex]
  m \ts_{A\implies B} n & \Leftrightarrow & \mbox{\pbox\textwidth{$m \ts_A n$ or $m\ts_B n$ \\ or (for $m\neq *$) $ * \ts_B m$ and $* \ts_A n$\,.}} \\[1.0ex]
  P_{A\implies B} & = & \{s\in L_{A\implies B}\suchthat s\vert_A\in P_A\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}

\subsubsection{Modelling countable nondeterminism}

Our definition of a strategy will be modelled upon that given in \cite{mcCHFiniteND}.  
We model nondeterministic computations by relaxing the determinism constraint on strategies -- so player $P$ may have multiple replies to any given $O$-move.  

In addition, we have to keep track of any possible divergence in the computation; this is so we can distinguish terms such as
\begin{mathpar}
  \IfO \wn\;\Omega\;\0 \and \0\,,
\end{mathpar}
where the term on the right must converge (to $\0$), while the term on the left has a possible divergence.  
The traditional way of representing divergences in game semantics is by a partiality in the strategy; i.e., an $O$-move to which $P$ has no reply, but this partiality will be obscured by the alternative behaviour in the denotation of the strategy on the left.  

We follow \cite{mcCHFiniteND} by modelling a strategy as a pair $(T_\sigma,D_\sigma)$, where $T_\sigma$ is a nondeterministic strategy in the usual sense and $D_\sigma$ is a set of $O$-plays after which there is a possibility of divergence.  

Tracking divergences explicitly in this way requires some care when we compose strategies.  
Specifically, we need to be able to add new divergences into strategies when they arise through `infinite chattering' or \emph{livelock}.  
For example, the denotation of the term
\[
  M = \Y_{\nat\to\nat}(\lambda f.\lambda n.n;(f n))\,,
  \]
where $n;P$ is a shorthand for $\IfO n\;P\;P$, is given by a total strategy, without divergences: namely the strategy $\mu$ with plays of the form
\[
  \begin{array}{cc}
    \mathbf{\bN} & \mathbf{\bN} \\
    & q \\
    q & \\
    n_1 & \\
    q & \\
    n_2 & \\
    \vdots &
  \end{array}\,.
  \]
However, when we compose this strategy with any total strategy for $\bN$ on the left, we expect the resulting strategy to contain divergences, since the term $M \n$ diverges for any $\n$.

The approach adopted in \cite{mcCHFiniteND} is to check specifically for infinite chattering between strategies $\sigma\from A\implies B$ and $\tau\from B\implies C$ by checking whether the set $\sigma\|\tau$ contains any infinite increasing sequence of plays ending with moves in $B$.  
If there is such a sequence, then it restricts to some $O$-position in $\sigma;\tau$ and we add in a divergence at that position.  

This works very satisfactorily for finite nondeterminism, but not at all for countable nondeterminism.  
To see why, consider the term
\[
  N = \Y_{\nat\to\nat\to\nat}(\lambda g.\lambda m n.\IfO m\;\0\;n;(g\;(\pred m)\;n))\wn
  \]
This term first chooses a natural number $m$, and then reads from its input $n$ for a total of $m$ times before eventually returning $\0$.  
Thus, its denotation is the strategy $\nu$ with maximal plays of the form:
\[
  \begin{array}{cc}
    \mathbf{\bN} & \mathbf{\bN} \\
    & q \\
    q & \\
    n_1 & \\
    \vdots & \\
    q & \\
    n_m & \\
    & 0
  \end{array}\,.
  \]
Note that this strategy strictly contains the one we considered before, and therefore that the denotation of
\[
  \IfO \wn M N
  \]
has the same denotation as $N$, even though it has all the divergent evaluations of $M$, while $N\n\mustconverge$ for all $\n$.
Moreover, if we try to compose $\deno{N}$ with the strategy on $\bN$ that always returns $1$, then we end up with an infinite increasing sequence of positions, which triggers the introduction of a divergence into the composite -- even though no divergence occurs in the evaluation of $N$.

Aside from making violating soundness for the model, this example actually leads to composition not being associative if we naively extend the Harmer-McCusker model from finite to infinite nondeterminism (e.g., see \cite[4.4.1]{RusssThesis}).  

Somehow, the crucial point is that we need to distinguish between terms like $M$, which contain infinite sequences of moves, and terms like $N$, which contain arbitrarily large finite sequences of oves.  
The way that we do this is by making the infinite sequences of moves explicit in our strategies, in the style of \cite{RoscoeCspInfinite} and \cite{LevyGsInfinite}.  
Then the denotation of $M$ will contain an infinite sequence, while the denotation of $N$ will contain arbitarily long finite sequences, but no infinite sequences.  

The games in our model will be the same as those that we considered in the last section, but our definition of a strategy will change.

\subsubsection{Strategies}

Given an arena $A$, we define an \emph{infinite justified string} in the obvious way.  
We define $\bar{P_A}$ to be $P_A$ together with the set of all those infinite justified sequences that have all finite prefixes in $P_A$.

Let $A$ be a game.  
A \emph{strategy} $\sigma$ for $A$ is a pair $(T_\sigma,D_\sigma)$, where:
\begin{itemize}
  \item $T_\sigma$ is a non-empty prefix-closed subset of $\bar{P_A}$ such that if $s\in T_\sigma$ is a $P$-position and $sa\in P_A$ then $sa\in T_\sigma$.
  \item $D_\sigma\subset \bar{P_A}$ is a postfix-closed set of plays in $\bar{P_A}$ that either end with an $O$-move or are infinite.  
    We require $D_\sigma$ to obey the following rules:
    \begin{description}
      \item[Divergences come from plays] If $d\in D_\sigma$ then there exists some $s\prefix d$ such that $s\in T_\sigma\cap D_\sigma$.
      \item[Diverge-or-reply] If $s\in T_\sigma$ is an $O$-position, then either $s\in D_\sigma$ or $sa\in T_\sigma$ for some legal play $sa$.
      \item[Infinite positions are divergent] If $s\in T_\sigma$ is infinite, then $s\in D_\sigma$.
    \end{description}
\end{itemize}

\subsubsection{Composition of strategies}

Given games $A,B,C$, we define a justified string over $A,B,C$ to be a sequence $\s$ of moves with justification pointers from all moves except the initial moves in $C$.  
Given such a string, we may form the restrictions $\s\vert_{A,B}$ and $\s\vert_{B,C}$ by removing all moves in either $C$ or $A$, together with all justification pointers pointing into these games.  
We define $\s\vert_{A,C}$ to be the sequence formed by removing all moves from $B$ from $\s$ and all pointers to moves in $B$, \emph{unless} we have a sequence of pointers $a \to b \to c$, in which case we replace them with a pointer $a \to c$.

We call such a sequence $\s$ a \emph{legal interaction} if $\s\vert_{A,B}\in P_{A\implies B}$, $\s\vert_{B,C}\in P_{B\implies C}$ and $\s\vert_{A,C}\in P_{A\implies C}$.  
We write $\Int_\infty(A,B,C)$ for the set of (possibly infinite) legal interactions between $A$, $B$ and $C$.

Now, given strategies $\sigma\from A \implies B$ and $\tau\from B \implies C$, we define
\[
  T_\sigma\|T_\tau = \{\s\in\Int_\infty(A,B,C)\suchthat \s\vert_{A,B}\in T_\sigma,\;\s\vert_{B,C}\in T_\tau\}\,,
  \]
and then set
\[
  T_{\sigma;\tau} = \{\s\vert_{A,C}\suchthat \s\in T_\sigma\|T_\tau\}\,.
  \]
As for divergences in $\sigma;\tau$, our approach is actually simpler than that in \cite{mcCHFiniteND}; we set
\[
  D_\sigma\dv D_\tau = \left\{\s\in \Int_\infty(A,B,C)\;\middle|\; \mbox{\pbox{\textwidth}{\textbf{either} $\s\vert_{A,B}\in D_\sigma$\\ \hspace*{12pt}and $s\vert_{B,C}\in T_\tau$ \\ \textbf{or} $\s\vert_{A,B}\in T_\sigma$ \\\hspace*{12pt}and $s\vert_{B,C}\in D_\tau$}}\right\}\,.
  \]
We then set
\[
  D_{\sigma;\tau} = \pocl_{A\implies C}\{\s\vert_{A,C}\suchthat\s\in D_\sigma\dv D_\tau\}\,,
  \]
where $\pocl X$ denotes the \emph{postfix closure} of $X$; i.e., the set of all $O$-plays in $P_{A\implies C}$ that have some prefix in $X$.

Note that there is no need to consider separately, as Harmer and McCusker do, divergences that arise through `infinite chattering': in our model, a case of infinite chattering between strategies $\sigma$ and $\tau$ is itself a legal interaction between the two strategies, which is necessarily divergent (because it is infinite) and therefore gives rise to some divergence in $\sigma;\tau$.

We need to impose one more condition on strategies:
\begin{definition}
  Let $\sigma$ be a strategy for a game $A$.  
  We say that $\sigma$ is \emph{complete} if $T_\sigma=\bar{T_\sigma}$; i.e., $T_\sigma$ contains an infinite position $s$ if it contains every finite prefix of $s$.  
\end{definition}

Any finite-nondeterminism strategy in the sense of \cite{mcCHFiniteND} may be interpreted as a complete strategy by enlarging it with all its infinite limiting plays.  
However, when we introduce countable nondeterminism, we introduce the possibility of strategies that are not complete.  
For example, the strategy $\nu$ that we mentioned above has an infinite increasing sequence of plays $q0\prefix q0q0\prefix \cdots$, but has no infinite play corresponding to its limit.  
Nonetheless, we do not want to allow arbitrary strategies: for example, the strategy $\mu$ above should include the infinite play $qq0q0\dots$; the strategy $\mu^\circ$ formed by removing this infinite play has no meaning in our language.  
Indeed, if we compose $\mu^\circ$ with the strategy $\0$ for $\bN$ on the left, then the resulting strategy does not satisfy diverge-or-reply.

\begin{definition}
  Let $\sigma$ be a strategy for a game $A$.  
  We say that $\sigma$ is \emph{locally complete} if it may be written as the union of complete strategies; i.e., there exist $\sigma_\alpha$ such that $T_\sigma=\bigcup T_{\sigma_\alpha}$ and $D_\sigma=\bigcup D_{\sigma_\alpha}$.
\end{definition}

From now on, we will use `strategy' to mean \emph{locally complete strategy}.

We need to show that the composition of locally complete strategies is locally complete.  
Note that this does not hold for \emph{complete} strategies: for example, our term $N$ above can be written as $N'\;\wn$, where $N'$ is a deterministic term with complete denotation $\nu'$.  
Then we have $\nu=\top_{\bN};\nu'$, but $\nu$ is not complete.
However, we can show that the composition of \emph{deterministic} complete strategies is complete; since a locally complete strategy may always be written as the union of complete deterministic strategies, this is sufficient to show that the composition of locally complete strategies is locally complete.

\begin{definition}
  We say that a strategy $\sigma$ for a game $A$ is \emph{deterministic} if
  \begin{itemize}
    \item it is complete;
    \item whenever $sab,sac$ are $P$-plays in $T_\sigma$ we have $b=c$ and the justifier of $b$ is the justifier of $c$;
    \item If $s\in D_\sigma$ then either $s$ is infinite or there is no $a$ such that $sa\in T_\sigma$.
  \end{itemize}
\end{definition}

\begin{lemma}
  Let $A,B,C$ be games and let $\sigma\from A\implies B$, $\tau\from B\implies C$ be deterministic complete strategies.  
  Then $\sigma;\tau$ is complete.
\end{lemma}
\begin{proof}
  The proof relies on a lemma from \cite{hoPcf} that states (in our language) that if $\sigma$ and $\tau$ are deterministic strategies and $s\in T_{\sigma;\tau}$ then there is a unique minimal $\s\in T_\sigma\|T_\tau$ such that $\s\vert_{A,C}=s$.  
  That means that if $s_1\prefix s_2\prefix \cdots$ is an infinite increasing sequence of plays in $T_{\sigma;\tau}$, with infinite limit $s$, then there is a corresponding infinite increasing sequence of legal interactions $\s_1 \prefix \s_2 \prefix \cdots$.  
  Then the limit of this sequence is an infinite legal interaction $\s$ and we must have $\s\vert_{A,B}\in\sigma$, $\s\vert_{B,C}\in\tau$ by completeness of $\sigma$ and $\tau$.  
  Therefore, $s=\s\vert_{A,C}\in T_{\sigma;\tau}$.
\end{proof}

\begin{corollary}
  The composition of strategies $\sigma\from A\implies B$ and $\tau\from B \implies C$ is a well-formed strategy for $A\implies C$.
\end{corollary}
\begin{proof}
  The only tricky point is eastablishing that diverge-or-reply holds for $\sigma;\tau$.  
  Again, it is sufficient to prove this in the case that $\sigma$ and $\tau$ are deterministic and complete.
  Then it essentially follows from the argument used in \cite{abramskyjagadeesangames} that shows that a partiality at an $O$-position $s\in T_{\sigma;\tau}$ must arise either from a partiality in $T_\sigma$ or $T_\tau$ or from `infinite chattering' between $\sigma$ and $\tau$.  
  In the first case, the diverge-or-reply rule for $\sigma$ and $\tau$ gives us a divergence at $s$ in $\sigma;\tau$.  
  In the second case, an infinite chattering between $\sigma$ and $\tau$ corresponds to an infinite interaction $\s\in\int(A,B,C)$ ending with infinitely many moves in $B$ such that $\s\vert_{A,C}=s$. 
  Completeness for $\sigma$ and $\tau$ tells us that $\s\vert_{A,B}\in D_\sigma$ and $\s\vert_{B,C}\in D_\tau$ and therefore that $\s\vert_{A,C}\in D_{\sigma;\tau}$.  
\end{proof}

\subsubsection{Associativity of composition}

In fact, the proof of associativity of composition is pretty much the same in our model as it is in any other model of game semantics.  
However, it is worth saying a few words about it, since the model obtained by naively extending the Harmer-McCusker model to unbounded nondeterminism does not have an associative composition.  
The point is that this is not really a problem with associativity, but rather that this naive model gives the wrong result for the composition of strategies.  
For example, if $\nu$ is the strategy we defined above, and $\0$ is the `constant $0$' strategy on $\bN$, then $\0;\nu$ has a divergence in the naive model, because the strategies $\0$ and $\nu$ appear to be engaged in infinite chattering.  
In our model, we have fixed that problem, because the strategy $\nu$ contains no infinite plays, and so no divergences arise in the composition.

\subsection{A symmetric monoidal closed category}

Given a game $A$, we define a strategy $\id_A$ on $A\implies A$, where $T_{\id_A}$ is given by
\[
  \{s\in P_{A_1\implies A_2}\suchthat\textrm{for all even-length }t\prefix s,\;t\vert_{A_1}=t\vert_{A_2}\}\,,
  \]
where we distinguish between the two copies of $A$ by calling them $A_1$ and $A_2$, and where $D_\sigma$ is the set of all infinite plays in $T_\sigma$.
This is an identity for the composition we have defined, and so we get a category $\G_{ND}$ of games and nondeterministic strategies.
Moreover, the connectives $\tensor$ and $\implies$ exhibit $\G_{ND}$ as a symmetric monoidal closed category.  

$\G_{ND}$ has an important subcategory $\G_D$ of deterministic complete strategies; this category is isomorphic to the category considered in \cite{SamsonGuyIAPassive}.

\subsection{Products and Exponentials}

Let $A, B$ be games
We define a new game $A \times B$.  
The arena for $A\times B$ is the same as the arena for $A\tensor B$, but now $P_{A\times B}$ is the disjoint union of $P_A$ and $P_B$ inside that arena:
\begin{IEEEeqnarray*}{RCL}
  P_{A \times B} & = & \{s\in L_{A\tensor B}\suchthat s\vert_A \in P_A\text{ and }s\vert_B=\emptyplay\} \\
  & \cup & \{s\in L_{A\tensor B}\suchthat s\vert_A=\emptyplay\text{ and }s\vert_B\in P_B\}\,.
\end{IEEEeqnarray*}
Then $A\times B$ is the category-theoretic product of $A$ and $B$ in $\G_{ND}$.

We define a game $\oc A$ as follows.  
The arena for $\oc A$ is the same as the arena for $A$, but the set of plays is given by
\[
  P_{\oc A} = \{s\in L_A\suchthat s\vert_m\in P_A\text{ for each initial move $m$}\}\,.
  \]
There are strategies $\mult_A\from \oc A \to \oc A \tensor \oc A$, $\coh\from \oc (A\times B) \toisom \oc A \tensor \oc B$ and $\der_A\from \oc A \to A$ that can be used to create a Cartesian closed category $\G^\oc_{ND}$, in which morphisms from $A$ to $B$ are strategies for the game $\oc A\implies B$.  
See \cite{SamsonGuyIAPassive} for full details.

\subsection{Constraining strategies}

Given a non-empty justified string $s$ in an arena $A$, we define the \emph{$P$-view} $\pv s$ of $s$ inductively as follows.
\begin{IEEEeqnarray*}{rClCR}
  \pv{sm} & = & m\,, &\qquad& \text{if $m$ is initial;} \\
  \pv{sntm} & = & \pv s n m\,, && \text{if $m$ is an $O$-move and} \\
  &&&&\text{$n$ justifies $m$;} \\
  \pv{sm} & = & \pv s m\,, && \text{if $m$ is a $P$-move.}
\end{IEEEeqnarray*}

We say that a play $sm$ ending in a $P$-move is \emph{$P$-visible} if the justifier of $m$ is contained in $\pv{m}$.  
We say that a strategy $\sigma$ for a game $A$ is \emph{visible} if every $P$-position $s\in T_\sigma$ is $P$-visible.
It can be shown that the composition of visible strategies is visible, and that we can build a Cartesian closed category using our exponential.  

The resulting category $\G^\oc_{D,vis}$ of games and deterministic visible strategies is a fully abstract model of Idealized Algol \cite{SamsonGuyIAPassive}.

\subsection{Recursive games and strategies}

Most full abstraction results go via a definability result that says that all \emph{compact} strategies are definable \cite{curienFullAbstraction}.
However, deducing full abstraction from compact definability makes essential use of continuity properties that are absent when we deal with countable nondeterminism.  
We will therefore need to appeal to a stronger result -- that of \emph{universality}, which states that \emph{every} strategy is definable.  
Clearly, universality does not hold for any of our categories of games, since there are many non-computable functions $\bN\to\bN$.  
However, Hyland and Ong proved in \cite{hoPcf} that every \emph{recursively presentable} innocent strategy is PCF-definable.  

In order to define recursively presentable strategies, we need to work with \emph{enumerated games}; i.e., games where the set of moves comes with an enumeration to the natural numbers.  
Clearly our base games $\bN$ and $\bC$ can be enumerated, as can the tensor product, linear implication, exponential and product of games.  

\begin{proposition}
  Let $\G_{D,vis,rec}$ be the category of games and \emph{recursive} visible strategies.  
  Then every morphism in $\G$ is definable in Idealized Algol.
\end{proposition}
\begin{proof}
  This follows from the corresponding results for PCF, together with the \emph{innocent factorization} result of \cite{SamsonGuyIAPassive}.  
  See also 
\end{proof}

\subsection{Determinisitic Factorization}

Our definability results will hinge on a \emph{factorization theorem}, showing that every nondeterministic strategy may be written as the composition of a deterministic strategy with the nondeterministic `oracle' $\top$.  


\section{Cones on Monoidal Functors}

\subsection{Surjective and winning strategies}

A useful fact about the category $\G$ of games and deterministic strategies, proved in \cite{hylandSchalkGames}, is that it admits a faithful, monoidal and linearly distributive functor into the category $\Rel$ of sets and relations, with monoidal structure given by the Cartesian product and exponentials given by the multiset comonad $W$.  
The functor sends a game $A$ to the set $P_A$ and sends a strategy $\sigma\from A\implies B$ to the relation
\[
  \grel{\sigma}=\{(s\vert_A,s\vert_B)\suchthat s\in\sigma\}\subset P_A\times P_B
  \]

Given a strategy $\sigma\from A\implies B$, we say that $\sigma$ is \emph{surjective} if $\grel{\sigma}$ is a surjective relation; i.e., if for any $b\in P_B$ there exists some $s\in\sigma$ such that $s\vert_B=b$.  
Monoidality and linear distributivity of the Hyland-Schalk functor $\G\to\Rel$ show that the composition of surjective strategies is surjective, as is the tensor product of surjective strategies and the bang of a surjective strategy.  

Given a strategy $\sigma\from A\implies B$, we say that $\sigma$ is \emph{winning} if $\sigma$ is total and if for all positions $s\in\sigma$, if $sb\in\sigma$, where $b$ is an $O$-move in $B$, then there is some $t\in\sigma$ such that $sb\prefix t$ and $t$ ends with a move in $B$.  

Once again, the composition, tensor product and bang of winning strategies is still winning.  
One way of seeing this is by relating our definition to the definition of a winning strategy given in \cite{abramskyjagadeesangames}, in which a game comes attached with a set of winning infinite positions.  
Then we say that a strategy $\sigma$ is winning if it is total and if every infinite position arising as the limit of plays in $\sigma$ is a winning position.  
If $A$ and $B$ are such that every infinite position is winning, then our notion of a winning strategy coincides with that notion.  

The reason we are interested in surjective winning strategies is that they preserve top strategies:

\begin{lemma}
  We say that a game $A$ is \emph{$P$-winning} if for all $O$-positions $s\in P_A$ there exists some $a$ such that $sa\in P_A$.  
  Let $A,B$ be $P$-winning games, and let $\sigma\from A\implies B$ be a surjective winning strategy.  
  Write $\top_A$ for the (nondeterministic) strategy given by $T_{\top_A}=P_A$ and $D_{\top_A}=P_A^\omega$ (i.e., the only divergent plays are the infinite ones), and do the same for $B$.
  Then $\top_A;\sigma=\top_B$.  
\end{lemma}
\begin{proof}
  We can show that $T_{\top_A;\sigma}=T_{\top_B}$ from surjectivity of $\sigma$, using the Hyland-Schalk functor, since the equivalent result clearly holds in $\Rel$.  
  Now suppose that $s$ is some divergent position in $\top_A;\sigma$.  
  Then $s=\s\vert_B$, where $\s$ is a position in $\sigma$ and $\s\vert_A$ is a divergent position in $A$.
  Then $\s\vert_A$ must be infinite; since $\sigma$ is winning, this means that $\s\vert_B$ must be infinite as well, and therefore that $s\in D_{\top_B}$.  
  \label{lem:sw}
\end{proof}

We now define a category $\G_{sw}$ whose objects are $P$-winning games and where the morphisms from a game $A$ to a game $B$ are deterministic surjective winning strategies from $A$ to $B$.  
We write $\G_{sw,rec}$ for the category where the morphisms are \emph{recursive} surjective, winning strategies.  

Write $j$ for the inclusion $\G_{sw,rec}\hookrightarrow\G_{rec}$, and write $J$ for the inclusion functor $\G\hookrightarrow\G_{ND}$ that sends a deterministic strategy $\sigma$ to the strategy given by $T=\sigma$ and $D=\pocl\{s\in\sigma^-\suchthat sa\not\in\sigma\forall a\}$
Then the lemma we have just proves means that
\[
  \top \from I \Rightarrow J\circ j
  \]
is a natural transformation, where $I$ is the constant $I$ functor.

Moreover, we would expect Lemma \ref{lem:sw} to hold in \emph{any} sensible game-semantics model of nondeterministic PCF, so the following makes sense as a definition

\begin{definition}
  A \emph{game semantics category for nondeterministic PCF} is a category $\D$ together with a functor $J\from \G_{rec}\to\D$ and a natural transformation $\top\from I\Rightarrow J\circ j\from\G_{sw,rec}\to\D$.  
\end{definition}

\subsection{Generalized monoidal natural transformations}

We will need one more technical definition.

Let $\C'$,$C'$,$\D'$,$\D$ be monoidal categories, let $f\from\C'\to\C$, $g\from \D'\to \D$ be oplax monoidal functors and let $F\from\D'\to\C'$, $G\from\D\to\C$ be lax monoidal functors, as in Figure \ref{fig:generalized-monoidal-setup}.

\begin{figure}
  \[
    \begin{tikzcd}[row sep=large, column sep=large]
      \D' \arrow[r, "F", ""'{name=F}] \arrow[d, "g"']
        & \C' \arrow[d, "f"] \\
      \D \arrow[r, "G"', ""{name=G}]
        & \C
      \arrow[Rightarrow, from=F, to=G, "\phi"]
    \end{tikzcd}
    \]
  \caption{A generalized monoidal natural transformation $\phi$ is a particular sort of natural transformation between composites of lax and oplax monoidal functors.}
  \label{fig:generalized-monoidal-setup}
\end{figure}

We say that a natural transformation $\phi\from fF\bigto Gg$ is a \emph{generalized monoidal natural transformation} if the following two diagrams commute for all objects $X,Y$ of $\D'$:
\begin{mathpar}
  \begin{tikzcd}
    f F X \tensor f F Y \arrow[r, "\phi_X \tensor \phi_Y"]
      & G g X \tensor G g Y \arrow[d, "m_G"] \\
    f (F X \tensor F Y) \arrow[u, "m_f"] \arrow[d, "f m_F"']
      & G (g X \tensor g Y) \\
    f F (X \tensor Y) \arrow[r, "\phi_{X \tensor Y}"]
      & G g (X \tensor Y) \arrow[u, "G m_g"']
  \end{tikzcd}
  \and
  \begin{tikzcd}[column sep=small, row sep=small]
    %
      & f F I_{\D'} \arrow[rr, "\phi_I"]
        &[-1.2em]
          &[-1.2em] G g I_{\D'} \arrow[dr, "G \epsilon_g"]
            & \\
    f I_{\C'} \arrow[ur, "f \epsilon_F"] \arrow[drr, "\epsilon_f"]
      &
        &
          &
            & G I_{\D} \\
    %
      &
        & I_{\C} \arrow[urr, "\epsilon_G"]
          &
            &
  \end{tikzcd}\,.
\end{mathpar}
The particular structure that generalized natural transformations fit into is that of a \emph{double category} (see \cite{LimitsInDoubleCategories} for the definition); in particular, the double category $\SymmMonCat$ introduced in \cite{AdjointsInDoubleCategories}, in which the objects are symmetric monoidal categories, the horizontal morphisms are lax symmetric monoidal functors, the vertical morphisms are oplax symmetric monoidal functors and the $2$-cells are generalized monoidal natural transformations as defined above.  

Generalized monoidal natural transformations may thus be composed either horizontally or vertically in the usual way; i.e., given a pair of squares as in Figure \ref{fig:generalized-monoidal-setup} that may be pasted together along an edge, then we may define a generalized monoidal natural transformation across the pasted square.  
We write $\hc{\phi}{\psi}$ for the horizontal composition of natural transformations $\phi,\psi$ pasted together along an oplax monoidal functor and $\vc{\phi}{\psi}$ for the vertical composition of natural transformations $\phi,\psi$ pasted together along a lax monoidal natural functor.

\subsection{The cone of a monoidal functor}

Let $j\from \C'\to \C$ be an oplax monoidal functor.  
We define a \emph{$j$-category} to be a category $\D$ together with a lax monoidal functor $J\from\C\to\D$ and a generalized natural transformation $\phi\from I \to Jj$:
\[
  \begin{tikzcd}[row sep=large, column sep=large]
    \C' \arrow[r, "()", ""'{name=term}] \arrow[d, "j"']
      & I \arrow[d, "I"] \\
    \C \arrow[r, "J"', ""{name=J}]
      & \D
    \arrow[Rightarrow, from=term, to=J, "\phi"]
  \end{tikzcd}\,.
  \]
\begin{example}
  For example, our previous definition of a game semantics category for nondeterministic PCF can be thought of as a $j$-category, where $j$ is the inclusion functor $\G_{sw,rec}\hookrightarrow\G_{rec}$.  
\end{example}
We define a \emph{morphism of $j$-categories} going from a $j$-category $(\D',J',\phi')$ to a $j$-category $(\D,J,\phi)$ to be a lax monoidal functor $\F\from \D'\to\D$, sending $I$ to $I$, such that $J=\F\circ J'$ and $\phi$ is the vertical composition of $\phi'$ with the `identity transformation' given by this identity; i.e.:
\[
  \begin{tikzcd}[row sep=large, column sep=large]
    \C' \arrow[r, "()", ""'{name=term}] \arrow[d, "j"']
      & I \arrow[d, "I"] \\
    \C \arrow[r, "J'"'{name=Jprimedown}, ""{name=Jprime}] \arrow[d, "\id"']
      & \D' \arrow[d, "\F"] \\
    \C \arrow[r, "J", ""{name=J}]
      & \D
    \arrow[Rightarrow, from=term, to=Jprime, shift left=1.5ex, "\phi'"]
    \arrow[Rightarrow, from=Jprimedown, to=J, shift left=1.5ex, "\id"]
    \arrow[Rightarrow, from=term, to=J, shift right=3ex, "\phi"' near end]
  \end{tikzcd}\,.
  \]
Our main technical result in this section will be the following:
\begin{proposition}
  The category $j$-$\Cat$ of $j$-categories and $j$-category morphisms has an initial object $C_j$
\end{proposition}
By analogy with homotopy theory, we call this initial object the \emph{mapping cone} or \emph{cone} on $j$.

To see why this is useful, consider another important topic from the theory of semantics.  
We say that a $j$-category $(\D,J,\phi)$ satisfies \emph{$\phi$-factorization} if for any pair of objects $A$ and $B$ of $\C$ and for every morphism $f\from JA \to JB$ in $\D$, we may write $f$ as a composite
\[
  JA \xrightarrow{\lunit;\phi_X\tensor JA}
  Jj X \tensor JA \xrightarrow{m_J}
  J (jX \tensor A) \xrightarrow{J f'}
  JB\,,
  \]
where $X$ is some object of $\C'$ and $f'\from jX \tensor A\to B$ is some morphism in $\C$.
\begin{example}
  In the case that $j$ is the inclusion $\G_{sw,rec}\hookrightarrow\G_{rec}$, and $\phi=\top$, $\phi$-factorization is the same as \emph{deterministic factorization}: the idea that every morphism can be written as the composition of a deterministic recursive strategy with $\top_X$ for some $X$.
\end{example}

Then the following result is easy to prove:
\begin{proposition}
  Let $(\D,J,\phi)$ be a $j$-category satisfying $\phi$-factorization.  
  Suppose $\F\from\D'\to\D$ is a morphism of $j$-categories.  
  Then $\F$ is a full functor.
\end{proposition}
In particular, the unique $j$-category morphism $C_j\to\D$ is a full functor.  
This is useful, because we are viewing game semantic models of nondeterministic PCF as $j$-categories (for a particular $j$), and therefore we can see that $C_j$ admits a full functor into every such model that satisfies deterministic factorization.  
Since we typically require that our models satisfy such a factorization result, we can form any such model by taking $C_j$ and imposing some equivalence relation on the morphisms.  
This suggests that we might consider $C_j$ itself as our model of nondeterministic PCF.

\subsection{Constructing the cone}

We will now define what the cone $C_j$ is and give an outline of why it is initial in the category of $j$-categories.

Recall that we start with an oplax symmetric monoidal functor $j\from \C'\to\C$.  
The objects of $C_j$ are the objects of $\C$.  
Given objects $A,B$ of $\C$, the class of morphisms $A\to B$ is given by the colimit of the functor
\[
  \oppcat{\C'} \xrightarrow{\oppcat{j}}
  \oppcat{\C} \xrightarrow{\C[\blank\tensor A,B]}
  \Set\,.
  \]
That is, a morphism from $A$ to $B$ is a pair $(X,f)$, where $X$ is an object of $\C'$ and $f\from jX \tensor A \to B$ is a morphism in $\C$.  
Furthermore, $(X, f)$ and $(X', f')$ are considered to be equivalent if there is some morphism $h\from X'\to X$ in $\C'$ making the following diagram commute:
\[
  \begin{tikzcd}
    j X' \tensor A \arrow[r, "f'"] \arrow[d, "j h \tensor A"']
      & B \\
    j X \tensor A \arrow[ur, "f"']
      &
  \end{tikzcd}\,.
  \]
Given morphisms $(X,f)\from A \to B$, $(Y,g)\from B \to C$, the composite is given by $(Y\tensor X,f;g)$, where $f;g$ is the following composite in $\C$:
\begin{align*}
  j(Y\tensor X)\tensor A & \xrightarrow{m_j\tensor A}
    (jY \tensor jX) \tensor A \\ & \xrightarrow{\assoc}
      jY \tensor (jX \tensor A) \\ & \xrightarrow{jY \tensor f}
        jY \tensor B \xrightarrow{g}
          C\,.
\end{align*}
We can prove that this composition is associative using the usual coherence theorems for monoidal categories.  
Similarly, the symmetric monoidal structure from $\C$ induces a symmetric monoidal structure on $C_j$.  
If $\C$ is symmetric monoidal \emph{closed}, then so is $C_j$.

There is a functor $J\from \C\to C_j$ that is the identity on objects and which sends a strategy $f\from A \to B$ to the strategy
\[
  j I \tensor A \xrightarrow{\epsilon_j\tensor A}
  I \tensor A \xrightarrow{\lunit\inv}
  A \xrightarrow{f} B\,.
  \]
This functor is (strong) symmetric monoidal with respect to the monoidal structure on $C_j$.  
Lastly, the natural transformation $\phi\from I \Rightarrow J\circ j$ is given by the composite
\[
  \phi_X = jX \tensor I \xrightarrow{\runit\inv}
  jX\,,
  \]
considered as a morphism from $I$ to $jX$ in $C_j$.  
Proving that this is indeed a natural transformation makes essential use of the equivalence relation on morphisms in $C_j$.  
We can also prove that $\phi$ is a generalized monoidal natural transformation.  
Therefore, $C_j$ is a $j$-category.

Now suppose that $(\D,F,\psi)$ is another $j$-category.  
We define a functor $H\from C_j\to\D$ that sends an object $A=JA$ in $C_j$ to the object $FA$ in $\D$.  
Moreover, we send a morphism $f\from jX\tensor A \to B$ from $JA$ to $JB$ in $C_j$ to the following composite in $\D$:
\begin{align*}
  FA \xrightarrow{\lunit;\psi_X\tensor FA}
  FjX \tensor FA \xrightarrow{m_F}
  F (jX \tensor A) \xrightarrow{F f}
  F B\,.
\end{align*}
Proving that this is indeed a functor is a little tricky, and relies on $\psi$ being a generalized monoidal natural transformation.  
We can then go through and check that $H$ is indeed a morphism of $j$-categories.

In order to prove uniqueness, note that, as a morphism of $j$-categories, $H$ is determined on morphisms of the form $Jf$ by the equation $F = H \circ J$ and on morphisms of the form $\phi_X$ by the equation $\psi=\vc{\phi}{H}$.  
But now, if $f\from jX\tensor A \to B$ is any morphism from $A$ to $B$ in $C_j$, we may write $f$ as the composite
\[
  JA \xrightarrow{\lunit;\phi_X\tensor A}
  JjX \tensor JA \xrightarrow{m_J}
  J (jX \tensor A) \xrightarrow{Jf}
  JB\,;
  \]
i.e., $C_j$ satisfies $\phi$-factorization.  
Since the functor $H$ is required to be monoidal, this implies that it is determined everywhere on $C_j$ by the requirement that it be a morphism of $j$-categories.
Therefore, $C_j$ is initial in the category of $j$-categories.

A consequence of the initiality of the cone construction is that it is \emph{functorial}; that is, given a square of the following form:
\[
  \begin{tikzcd}[row sep=large, column sep=large]
    \C' \arrow[r, "F", ""'{name=term}] \arrow[d, "j"']
      & \D' \arrow[d, "j'"] \\
    \C \arrow[r, "G"', ""{name=J}]
      & \D
    \arrow[Rightarrow, from=term, to=J, "\psi"]
  \end{tikzcd}\,,
  \]
where horizontal arrows correspond to lax monoidal functors and vertical arrows to monoidal functors, we get an induced lax monoidal functor $C_{j}\to C_{j}$, in a way that respects horizontal pasting of squares.
In particular, if $\C$ and $\C'$ have linear structures, compatible with $j$, then $C_j$ inherits a linear structure.

\section{Denotational Semantics}

We now restrict our attention to the inclusion functor $j\from G_{sw,rec}\hookrightarrow \G_{rec}$.  
Then $C_j$ inherits a linear structure from $\G_{rec}$.  

\subsection{Extensional order}

Let $\sigma,\tau\from I \to \bN$ be morphisms in $C_j$, corrseponding to morphisms $\sigma'\from jX \to \bN$, $\tau'\from jY \to \bN$ in $\G_{rec}$.  
We say that $\sigma\lst\tau$ if the following two conditions hold:
\begin{itemize}
  \item If there exists $s\in \sigma'$ such that $s\vert_{\bN}=qn$, then there exists $t\in\tau'$ such that $t\vert_{\bN}=qn$.
  \item If $\sigma'$ is winning then $\tau'$ is winning.
\end{itemize}
In general, given strategies $\sigma,\tau\from I \to A$ in $C_j$, we say that $\sigma\lst\tau$ if for all morphisms $\rho\from A \to \bN$ we have $\sigma;\rho\lst\tau;\rho$.

We can show that this is well-defined; i.e., that it respects the equivalence relation we have already defined on morphisms.  
This is a good exercise to show the importance of surjective and winning strategies to our model.

\subsection{Countable nondeterminism}

In order to model \emph{countable} nondeterminism, rather than arbitrary nondeterminism, we want to constrain our model so that morphisms are strategies for $\oc\bN\tensor A \to B$, rather than $X \tensor A \to B$ for an arbitrary game $X$.  

Since $\oc\bN$ has the structure of a comonoid, it gives rise to an oplax monoidal functor
\[
  n\from I \to \G_{rec}\,,
  \]
where $I$ is the one-object monoidal category.  
Moreover, this functor is linear distributive from the trivial linear structure on $I$ on to $\G$.
The cone $C_n$ is therefore a linear category.  

Since $\G_{sw,rec}$ is a sub-linear category of $\G_{rec}$, the functor $n$ factors through a functor $n'\from I \to \G_{rec}$.  
By initiality of the cone construction, this gives rise to a functor $C_n\to C_j$.  
Our model of nondeterministic PCF will be the category $\C$ that is the image of this functor.
A morphism in $\C$ from a game $A$ to a game $B$ will be a strategy for $\oc \bN \tensor A \to B$, but the equivalence relation on morphisms is that from $C_j$.  
For example, two morphisms $f,g\from \oc\bN\to A$ are equivalent in $\C$ if there is a surjective winning strategy $\oc\bN\to \oc\bN$ commuting with $f$ and $g$, but they are not equivalent in $C_n$.  

In fact, once we have applied the extensional quotient, there is no difference between working in $\C$ and working in $C_n$.  
We will use $\C$, because it is closer to being a fully abstract model for nondeterministic PCF before we apply the extensional quotient.

\subsection{The denotation of a term}

Let $M=C[\wn]\from T$ be a term of nondeterministic PCF, where $C[-]$ is a PCF context (i.e., a context not mentioning the constant $\wn$).  
Then the denotation of $M$ in $\C$ is given by the following composite:
\[
  I \xrightarrow{\phi_{\oc\bN}}
  \oc \bN \xrightarrow{J (\deno{\lambda n. C[n]})}
  \deno{T}
  \]
In other words, when considered as a morphism in $\G_{rec}$, $\deno{M}$ is precisely the denotation of the term $\lambda n.C[n]$ in $\G_{rec}$.  

\subsection{Relation to our previous model}

Since our Harmer-McCusker-style model $\G_{ND}$

%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{../../common/phd_bibliography}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
