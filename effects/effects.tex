%%%%%%%%%%%%%%%%%%%% author.tex %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% sample root file for your "contribution" to a proceedings volume
%
% Use this file as a template for your own input.
%
%%%%%%%%%%%%%%%% Springer %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\documentclass{svproc}
%
% RECOMMENDED %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%

% to typeset URLs, URIs, and DOIs
\usepackage{url}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{tikz}
\usepackage{xspace}
\usepackage{IEEEtrantools}
\usepackage{mathtools}
\usetikzlibrary{cd}
\usepackage{mathpartir}
\usepackage{stmaryrd}
\def\UrlFont{\rmfamily}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
    \node[shape=circle,draw,inner sep=2pt] (char) {#1};}}
\newcommand{\deno}[1]{\left\llbracket#1\right\rrbracket}
\renewcommand{\ts}{{\;\vdash}}

\newcommand\C{\mathcal{C}}
\newcommand\D{\mathcal{D}}
\newcommand\F{\mathcal{F}}
\newcommand\G{\mathcal{G}}
\newcommand\M{\mathcal{M}}
\DeclareMathOperator\pr{pr}
\DeclareMathOperator\id{id}
\newcommand{\inv}{{}^{-1}}
\newcommand{\suchthat}{\,\colon\,}
\newcommand{\esuchthat}{\,.\,}
\newcommand\object\colon
\DeclareMathOperator{\ac}{ac}
\DeclareMathOperator{\End}{End}
\newcommand{\passoc}{\texttt{passoc}}
\newcommand{\assoc}{\texttt{assoc}}
\newcommand\tensor\otimes
\newcommand\run{\texttt{r}}
\newcommand\lun{\texttt{l}}
\newcommand\lunit{\texttt{lunit}}
\newcommand\runit{\texttt{runit}}
\renewcommand\implies\multimap
\newcommand{\pfc}{\boldsymbol{\cdot}}
\newcommand\Mellies{Melli\`{e}s\xspace}

\newcommand{\test}{\texttt{test}}

\let\oldemptyset\emptyset
\let\emptyset\varnothing
\newcommand{\nat}{{\mathtt{nat}}}
\newcommand*\from{\colon}
\newcommand{\Y}{\mathbf{Y}}
\newcommand{\opto}{\longrightarrow}
\newcommand{\n}{{\mathtt{n}}}
\newcommand{\x}{{\mathtt{x}}}
\newcommand{\IfO}{{\mathtt{If0}\;}}
\newcommand{\If}{{\mathtt{If}\;}}
\newcommand{\suc}{{\mathtt{suc\;}}}
\newcommand{\pred}{{\mathtt{pred\;}}}
\newcommand{\0}{{\mathtt{0}}} \newcommand{\com}{{\mathtt{com}}}
\newcommand{\skipp}{{\mathsf{skip}}}
\newcommand{\neww}{{\mathsf{new}}}
\newcommand{\mkvar}{{\mathsf{mkvar}\;}}
\newcommand{\deref}{\texttt{@}}
\newcommand{\ia}[2]{\langle #1 , #2 \rangle}
\newcommand{\stup}[3]{\langle #1 \mid #2 \mapsto #3 \rangle}
\newcommand{\Var}{{\mathtt{Var}}}
\newcommand{\new}{{\mathtt{new}}}
\renewcommand{\case}{{\mathtt{case}}}
\newcommand{\blank}{\;\underline{\hspace{1.5ex}}\;}
\newcommand{\converges}{\Downarrow}

\newcommand{\catname}[1]{\mathbf{#1}}
\newcommand{\Set}{\catname{Set}}
\newcommand{\Surj}{\catname{Surj}}
\newcommand{\Ret}{\catname{Ret}}
\newcommand{\Cat}{\catname{Cat}}
\newcommand{\DProb}{\catname{DProb}}
\newcommand{\BProb}{\catname{BProb}}
\newcommand{\powerset}{\mathcal P}
\usepackage{bbm}
\newcommand{\true}{\mathbbm{t}}
\newcommand{\false}{\mathbbm{f}}

\newcommand{\bR}{\mathbb{R}}
\newcommand{\bN}{\mathbb{N}}
\newcommand{\bB}{\mathbb{B}}
\newcommand{\bC}{\mathbb{C}}
\newcommand{\bP}{\mathbb{P}}

\DeclareMathOperator{\Prof}{Prof}
\DeclareMathOperator{\Kl}{Kl}

\newcommand{\coin}{\textsf{coin}}
\newcommand{\polydie}{\textsf{polydie}}
\newcommand{\multicoin}{\textsf{multicoin}}
\newcommand{\bool}{\textsf{bool}}

\renewcommand{\emptyset}{\varnothing}

\makeatletter
\newcommand{\colim@}[2]{%
  \vtop{\m@th\ialign{##\cr
    \hfil$#1\operator@font colim$\hfil\cr
    \noalign{\nointerlineskip\kern1.5\ex@}#2\cr
    \noalign{\nointerlineskip\kern-\ex@}\cr}}%
}
\newcommand{\colim}{%
  \mathop{\mathpalette\colim@{\rightarrowfill@\textstyle}}\nmlimits@
}
\makeatother

\begin{document}
\mainmatter              % start of a contribution
%
\title{A Kleisli-style construction for Parametric Monads, with Examples}
%
\titlerunning{A Kleisli-Style Construction}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
\author{}
%
\authorrunning{} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
\tocauthor{}
%
\institute{University of Bath, Claverton Down Road, Bath.  
BA2 7AY,\\
\email{wjg27@bath.ac.uk},\\ WWW home page:
\texttt{http://people.bath.ac.uk/wjg27}}

\maketitle              % typeset the title of the contribution

\begin{abstract}
  A well-known principle in denotational semantics is that adding an effect to a categorical model should correspond to the Kleisli category construction for some suitable monad.  
  Our point of departure is the observation that much recent work in semantics, particularly in game semantics, has broken away from this principle by modelling effects using categories that are not Kleisli categories.  
  Our aim is to extend the theory of monadic effects to these models in a systematic way.

  An important part of our approach will be to study parametric monads, otherwise known as lax actions of monoidal categories.
  These generalize monads: a monad is precisely an action of the trivial category.
  We introduce a construction on parametric monads which takes a parametric monad on a category and gives us back a new category.  
  As with the Kleisli category, the objects of this category will be the objects of the original category, while the morphisms are obtained from morphisms in the original category in a formal manner brought about by the action.  
  In the case that the action is actually a monad, we get the usual Kleisli category.

  We show that this new construction is closely related to existing models of effects in game semantics, allowing us to reason systematically about adequacy and full abstraction proofs.
  We illustrate the relevance of the construction by showing that a special case gives us a fully abstract game semantics for Probabilistic Algol, which can be related to the existing model given by Danos and Harmer.
\keywords{denotational semantics, category theory, game semantics}
\end{abstract}

\section{Introduction}

\subsection{Monads and Kleisli categories}

This paper is about general frameworks for modelling effects in a categorical semantics.  
The seminal paper in this field is Moggi's \emph{Computational Lambda-Calculus and Monads} \cite{Moggi}, which first put forward the idea that if $\C$ is a categorical model of a programming language, then we can simulate an effect in that language via a suitable \emph{monad} on $\C$.  
Given such a monad, its Kleisli category $Kl_M\C$ is then a model of a language formed by adding the effect to the original language.  

Spivey \cite{Spivey} and Wadler \cite{Wadler1,Wadler2} have transferred this theory to the real world by using monads as programming tools, particularly in the Haskell programming language.  

Monads are certainly not the only formal method of adding effects into categories.  
For example, \cite{Lawvere} argues that Lawvere theories, a tool used originally in universal algebra (as monads were), also give us a natural way to model effects in categories.  
Since \cite{FinitaryMonadOnSet} every Lawvere theory may be regarded as a particular monad on the category of sets, this is not surprising.  
However, Lawvere theories are a lot more flexible than monads when it comes to composing multiple effects together.

More recent work in game semantics, however, has produced models of effects -- such as the well-known game semantics for scoped state \cite{SamsonGuyIAPassive} and nondeterminism \cite{mcCHFiniteND} -- do not arise by applying any systematic procedure to a base category of games that lacks the effect.  
Instead, these models are typically built up using intuition -- for example, by relaxing the determinism condition on strategies to give a model of a nondeterministic language -- and do not readily fit into any category theoretic framework the way Kleisli categories do.  
The goal of this paper is to examine some possible frameworks that will allow us to study these and other models in a systematic way.  

A closely related problem is that of using a common technique to model a particular effect in different settings.  
Many of our favourite monads (e.g., the powerset monad on $\Set$ for nondeterminism) live in some particular category and cannot readily be set up in other categories. 

Before we start, it is worth mentioning one example of a Kleisli category arising naturally in game semantics.  
The \emph{slot games} defined in \cite{SlotGames} are defined like ordinary games, but their strategies are allowed to contain extra moves, called \emph{tokens}, which are meant to represent a point at which the computation takes up time or resources.  
For example, a strategy for a term of natural number type that returns the value $5$ after two CPU cycles could be represented by the strategy shown on the left of Figure \ref{slot-games}.  
Now, we can alternatively represent this strategy as being a normal strategy inside the Kleisli category for the reader monad given by the \emph{command} or \emph{singleton} type, as on the right of Figure \ref{slot-games}.  
The translation works by replacing each token $\circled{\$}$ with a request to the argument to the function: since this arguement has singleton type, there is only one possible value that can be passed in, but the game semantics will record that we have made the request.  
What is more, this translation respects composition in the two categories, both the Kleisli composition and the composition defined synthetically for slot games.
\begin{figure}
  \begin{mathpar}
    \begin{array}{c}
      \mathbf{\bN} \\
      q \\
      \circled{\$} \\
      \circled{\$} \\
      5 \\
    \end{array}
    \and
    \begin{array}{ccc}
      \mathbf{\bC} & \mathbf{\implies} & \mathbf{\bN} \\
      && q \\
      q && \\
      a && \\
      q && \\
      a && \\
      && 5
    \end{array}
  \end{mathpar}
  \label{slot-games}
  \caption{The `slot-games' denotation of a program that uses resources can also be represented in a Kleisli category.}
\end{figure}

Since the reader monad is entirely built out of the Cartesian closed structure of the category, we can perform a similar trick in many different settings, although perhaps not as successfully as in game semantics.  

\subsection{Promonads}

It is instructive at this point to see what happens if we generalize from functors to profunctors.  
We define a \emph{promonad} on a category $\C$ to be a monoid in the monoidal category $\Prof[\C,\C]$ of endo-profunctors on $\C$, where the monoidal product in $\Prof[\C,\C]$ is given by composition of profunctors.
This concept generalizes that of a monad, since an endofunctor $M\from \C\to\C$ may be identified with the profunctor $\C[\_,M(\_)]\from \C^{op}\times\C\to\Set$.

Since the set $\C[A,MB]$ is precisely the set of Kleisli morphisms from $A$ to $B$, it is natural to wonder whether we can perform a Kleisli-type construction on a promonad as well.  
it turns out that we can: if $\D\from \C^{op}\times\C\to\Set$ is a promonad, then we may define a category (also called $\D$) whose objects are the objects of $\C$, and where the morphisms from $A$ to $B$ are the elements of the set $\D(A,B)$.
The promonad action
\[
  (\D\pfc\D)(A,C) = \int^{B}\D(A,B)\times\D(B,C) \to \D(A,C)
  \]
gives us composition in our category and the unit
\[
  1(A,B)=\C[A,B]\to \D[A,B]
  \]
gives us a functor $\C\to\D$ (and, in particular, the identity morphisms).

In fact, the converse is true: if $\C$ and $\D$ are categories with the same objects and $J\from \C\to\D$ is an identity-on-objects functor, then the functor $\D(JA,JB)=\D(A,B)\from\C^{op}\times\C\to\Set$ may be given the structure of a promonad on $\C$.  
Thus, the rather complicated definition of a promonad is in fact equivalent to the much simpler idea of an identity-on-objects functor.
We shall therefore use the word `promonad' to mean both things.

In one sense this is very exciting for us, because we can see that promonads generalize not only monads, but also a very large number of the models developed in Game Semantics.  
For example, the inclusion of the category of games and deterministic strategies into the category of games and nondeterministic strategies from \cite{mcCHFiniteND} is the identity on objects, so it is a promonad.  
So is the inclusion of the category of games and innocent strategies (corresponding to stateless programs) into the category of games and visible strategies (corresponding to stateful programs) from \cite{SamsonGuyIAPassive}.

What these models have in common is that they model effects by changing the morphisms (i.e., the programs) but not the objects (i.e., the types).  
Though effectful types can be useful [REFERENCE?], the simplest way of adding effects is to give us new ways to create programs between existing types, and this is the formalism that we will adopt in this paper.

So promonads give a good general framework for the denotational semantics of effects.
On the other hand, their sheer generality means that they don't give us any ways to actually create new models, since the data required to specify one is the entire category that we are trying to build.

One way of describing the purpose of this work, then, is to discover classes intermediate between monads and promonads that are more general than pure monads but can still be specified in a concise way that allows us to transfer them between different settings.

\subsection{Monads on presheaf categories}

We can think of an endo-profunctor $\F\from \C^{op}\times\C\to \Set$ as a functor $\C\to [\C^{op},\Set]$.  
Since the Yoneda embedding exhibits $[\C^{op},\Set]$ as the free cocompletion of $\Set$, this can alternatively be characterized as a colimit-preserving endofunctor on $[\C^{op},\Set]$.  
Similarly, any promonad on $\C$ can alternatively be considered as a monad on $[\C^{op},\Set]$ whose underlying endofunctor preserves colimits.

\subsection{Parametric monads}

\Mellies \cite{ParametricMonads}, following work by Smirnov \cite{Smirnov2008}, has demonstrated that the concept of a lax monoidal category action is a useful generalization of that of a monad.  
A lax action of a monoidal category $\M$ upon a category $\C$ is a lax monoidal functor $\M\to \End[\C]$; monads are the special case when $\M$ is trivial.  
For this reason, \Mellies renames lax monoidal actions to `parametric monads', where we think of the action of $\M$ as a kind of monad on $\C$ that is parameterized by the objects of $\M$.

This idea has been further generalized by Katsumata \cite{Katsu}, who has given a definition of a `Kleisli-like resolution' of a parametric monad.  
This particular construction, which takes a parametric monad on a category $\C$ parameterized by a monoidal category $\M$ and yields a new category, generalizes many important properties of the Kleisli category -- in particular, it gives us an adjunction with the original category -- but it does not fit into our framework, since the objects of the category it creates are not the objects of the original category $\C$, but pairs of an object of $\C$ and an object of $\M$.

Once again, it is useful to generalize to profunctors.  
First, if $\C$ is a category and $\M$ a monoidal category, we define a \emph{parametric promonad on $\C$ parameterized by $\M$} to be a lax monoidal functor $\M\to\Prof[\C,\C]$.

As with promonads, we can now look at what we have defined and try to recast it as a particular kind of category.  
Suppose that $\D\from \M\times\C^{op}\times\C$ is a parametric promonad on $\C$ parameterized by $\M$.  
After some thought, we can see that $\D$ corresponds to a category whose objects are the objects of $\C$ and where the morphisms from $A$ to $B$ are labelled by objects of $\M$ in such a way that the composition of a morphism labelled with $X$ and a morphism labelled with $Y$ is a morphism labelled with $X\tensor Y$. 

One way to state this is as follows.  
Given a parametric promonad $\D\from \M\times\C^{op}\times\C\to \Set$, we define a bicategory $\D^2$:
\begin{itemize}
  \item whose objects are the objects of $\C$,
  \item where the $1$-morphisms from $A$ to $B$ are pairs $(X,f)$, where $X$ is an object of $\M$ and $f\in\D(X,A,B)$
  \item and where the $2$-morphisms from $(X,f)$ to $(Y,g)$ are morphisms $h\from X\to Y$ in $\M$ such that $\D(h,A,B)(f)=g$.
\end{itemize}
This bicategory comes equipped with two important bifunctors:
\begin{itemize}
  \item a bifunctor $J\from \C\to\D^2$ (where we consider $\C$ as a bicategory with only identity $2$-morphisms;
  \item a bifunctor $l\from \D^2\to \M$ given by the `labelling' (considering $\M$ as a bicategory with a single object).
\end{itemize}

In order to get a promonad resolution of the parametric promonad, then, we need to convert this bicategory into a $1$-category $\D$, which we do by quotienting out the $1$-morphisms in $\D^2$ by the action of the $2$-morphisms: i.e., the smallest equivalence relation such that two $1$-morphisms are related if there is a $2$-morphism from one to the other.

More explicitly, the set of $1$-morphisms from $A$ to $B$ in our new category will be given by the following colimit.
\[
  \D(A,B) = \colim_{X\object\M} \D(X,A,B)
  \]
This category $\D$ now admits an identity-on-objects functor from $\C$, meaning that we have found a natural collapse from parametric promonads to ordinary promonads.  

In the particular case that the parametric promonad is in fact a parametric \emph{monad}, then we will call the category we obtain $\C/\M$.  
The morphisms in $\C/\M$ are given by
\[
  \C/\M(A,B)=\colim_{X\object\M} \C(A,X.B)\,,
  \]
with the composition of $f\from A\to X.B$ and $g\from B\to Y.C$ being given by the composite
\[
  A \xrightarrow{f}
  X.B \xrightarrow{X.g}
  X.Y.C \to
  (X\tensor Y).C\,.
  \]
Note that if $\M$ is the trivial category (so that the action is in fact a monad), then the category $\C/\M$ is the usual Kleisli category.

\subsection{Effects, monads and colimits}

The colimit that appears in the definition of the category $\C/\M$ is instructive, because it is linked to the fact that many important monads may be expressed as colimits.  
For example, let $\Surj$ be the category of sets and surjections.  
Then, if $A$ is a set, we have
\begin{IEEEeqnarray*}{CCC}
  \colim_{X\object\Surj^{op}} [X,A] & \cong & \powerset(A) \\[6pt]
  \left(X \xrightarrow{f} A\right) & \mapsto & \text{Im}(f)\,,
\end{IEEEeqnarray*}
naturally in $A$.

This is useful, because the body of the colimit -- i.e., the function set $[X,A]$ -- has a natural equivalent inside any Cartesian closed category that admits a functor out of $\Set$.  
Moreover, the functor $[X,A]$ is actually an \emph{action} of $\Surj^{op}$ (with the Cartesian product) upon the category of sets.  
So even though we cannot define the powerset \emph{monad} inside arbitrary Cartesian closed categories, we can still define this action of $\Surj^{op}$.  

Unfortunately, when we try to apply our construction to this action in the category of sets, we do not get the usual Kleisli category for the powerset monad.  
To see why, note that from the discussion above, we have
\begin{IEEEeqnarray*}{rCl}
  \Set/\Surj^{op}(A,B) & = & \colim_{X\object\Surj^{op}}[A,[X,B]] \\
  & \cong & \colim_{X\object\Surj^{op}}[X,[A,B]] \\
  & \cong & \powerset([A,B])\,,
\end{IEEEeqnarray*}
while the morphisms in the Kleisli category take a different form:
\[
  \Kl_{\powerset}\Set(A,B) = [A,\powerset(B)]\,.
  \]
Nevertheless, there are still a few things we can take from this.  
The sets $\powerset([A,B])$ and $[A,\powerset(B)]$ are not equal, but there is still a natural function
\[
  \powerset([A,B]) \to [A,\powerset(B)]\,,
  \]
that sends a set $\F$ of functions to the function $h$ (the \emph{amalgamation} of $\F$) where
\[
  h(a) = \{f(a)\suchthat f \in \F\}\,.
  \]
This amalgamation function is not \emph{quite} surjective: for example, suppose that $g\from \{0,1\}\to \powerset(\{0\})$ sends $0$ to $\{0\}$ and $1$ to the empty set.  
Then $g$ is not the amalgamation of any set of functions $\{0,1\}\to\{0\}$.  
However, if we use the \emph{nonempty powerset monad} $\powerset^+$ (which corresponds to taking the colimit over the opposite of the category $\Surj^+$ of nonempty sets and surjections), then the amalgamation function gives us a surjection
\[
  \powerset^+([A,B])\twoheadrightarrow [A,\powerset^+(B)]\,.
  \]
This means that we can recover the Kleisli category for the nonempty powerset monad on $\Set$ by taking the quotient by a suitable equivalence relation to the category $\Set/(\Surj^{+\,op}$).  

In fact, this surjection has a natural right inverse, formed by sending a function $h\from A\to\powerset^+(B)$ to the \emph{largest} possible set $\F\subseteq[A,B]$ such that for all $f\in \F$ and $a\in A$, $f(a)\in h(a)$.
The composition of these inverses sends a set of functions $A\to B$ to its `amalgamation closure':
\[
  \ac(\F) = \{g\from A \to B\suchthat\forall a\in A\esuchthat g(a)=f(a)\text{ for some $f\in \F$}\}\,.
  \]
By restricting our set of morphisms, then, to those that are fixed points of this operator, we may recover the Kleisli category for $\powerset^+$.  

In the next section, we will see how to generalize this idea to other monads, and to other categories.

\subsection{Weakly filtered colimits}

Suppose we have a lax action of a monoidal category $\M$ upon a cocomplete category $\C$.  
Then we may copy the collapse from parametric promonads to promonads and define a monad on $\C$ given by:
\[
  M A = \colim_{X\object\M}A.X\,.
  \]
Unfortunately, as in the case of the powerset monad above, this transformation does not commute with the collapse from parametric promonads to promonads.  
Indeed, if we consider our action as a parametric promonad and apply the collapse, then we get a category where the morphisms from $A$ to $B$ are given by the colimit
\[
  \colim_{X\object\M} \C(A,X.B)\,,
  \]
while the morphisms from $A$ to $B$ in the Kleisli category for the monad $M$ are given by
\[
  \C(A,\colim_{X\object\M} X.B)\,.
  \]
There is a natural morphism from the first colimit into the second expression, but it is not an isomorphism in general.
If $\C$ is the category of sets, there is a well known result that states that if $\M$ is a $\kappa$-filtered category and $|A|<\kappa$, then the colimit will commute with the functor $[A,\_]$, but this does not help us, since the category $\M$ is not filtered in most of the cases we are interested in (e.g., the category $\Surj^{op}$ has not got morphisms coequalizing parallel pairs, since such maps cannot be chosen to be surjective in general).  

Instead, we try for the next best thing, which is to show that the natural map $\colim_{X\object\M}\C(A,X.B)\to\C(A,\colim_{X\object\M}X.B)$ is a surjection if $\M$ satisfies some weaker conditions.  

We define (see, for example, \cite[Def. 16]{WeaklyFiltered}) a \emph{$\kappa$-weakly filtered category} to be one in which every \emph{discrete} diagram of size $<\kappa$ admits a cocone; i.e., a non-empty category such that whenever $(X_\alpha)_{\alpha<\kappa}$ is a collection of objects we have some object $Y$ and morphisms $X_\alpha\to Y$ for each $\alpha$.  

\begin{example}
  The category $\Surj^{+\,op}$ is $\kappa$-weakly filtered for arbitrary $\kappa$, because if $(X_\alpha)_{\alpha<\kappa}$ is a collection of sets, then we can take their Cartesian product, and the projections will be surjective.

  The category $\Surj^{op}$ is not weakly filtered, because if there is a surjection from an object $X$ to the empty set, then there is no surjection from $X$ to any other set.
\end{example}

The importance of $\kappa$-weakly filtered limits is shown by the following result.

\begin{proposition}
  \label{prop:weakly-filtered}
  If $\M$ is a $\kappa$-weakly filtered category, $D\from \M\to \Set$ is a functor and $A$ is a set with cardinality less than $\kappa$, then the natural function
  \[
    \colim_{X\object\M}[A,D(X)]\to [A,\colim_{X\object\M}D(X)]
    \]
  is a surjection.
\end{proposition}
\begin{proof}
  Given a function $h\from A \to \colim_{X\object\M}D(X)$, for each $a\in A$, choose some $X_a\object\M$ such that $h(a)\in D(X_a)$.  
  Since $\M$ is $\kappa$-weakly filtered, there is some object $Y$ of $\M$ that admits morphisms out of all of the $X_a$, and therefore $h$ may be considered as a function $A \to D(Y)$. \qed
\end{proof}

By setting $D(X)=X.B$, this means that if we have a lax action of $\M$ on $\Set$, where the monoidal category $\M$ is $\kappa$-weakly filtered for any $\kappa$, then we get a full functor $\Set/\M\to\Kl_M\Set$.

Moreover, if the colimit satisfies additional properties, then the $Y$ in the proof of Proposition \ref{prop:weakly-filtered} can be chosen in a functorial manner, so that we get a faithful right inverse to this full functor.

\begin{example}
  If $f\from A \to \colim_{X\object\Surj^{+\,op}}[X,B]$ is a function with $f(a)\in [X_a,B]$ for each $a$, then $f$ is equivalent to a function
  \[
    \tilde{f}\from A \to \left[\prod_{a\in A}X_a,B\right]
    \]
  via the surjections $\prod_{a\in A}X_a\to X_b$ for each $b\in A$.  
  The operator $f\mapsto\tilde{f}$ is well-defined in this case, and gives rise to the amalgamation functor that we considered in the previous section.
\end{example}

The point of these last two sections can be summarized as follows.  
If a monad $M$ on $\Set$ can be expressed as the colimit of a lax action of a weakly filtered monoidal category $\M$ on $\Set$, then we do not lose very much by considering the category $\Set/\M$ obtained from the action rather than the Kleisli category $\Kl_M\Set$.  
More specifically, there is a full functor $\Kl_M\Set\to \Set/\M$ that is the identity on objects, so we may recover the Kleisli category by applying a suitable equivalence relation to the set of morphisms.  

For example, since the nonempty power set monad may be expressed as the colimit of the lax action of the weakly filtered category $\Surj^{+\,op}$ on $\Set$, we get an alternative way to model it by using the category $\Set/\Surj^{+\,op}$ rather than the usual Kleisli category.  
Though these two categories are not equal, the colimit representation gives rise to a natural functor from one to the other, which is the same as the amalgamation functor that we defined earlier.

The benefit of reasoning about the action of $\M$ rather than the monad $M$ is that the action might be realizable in a much larger class of categories.  
For instance, the action of $\Surj^{+\,op}$ on $\Set$ may be replicated inside any monoidal closed category that admits a functor out of the category of sets (for example, most models of PCF or Idealized Algol).

\subsection{Plan for the paper}

The rest of this paper will consist in two sections.  
In the first, we will give a more detailed account of the construction that allows us to build a promonad (i.e., a category) out of a parametric monad.  

In the second section, we will give a fully abstract game semantics for the language Probabilistic Algol (PA).  
This is by no means a new result -- the paper \cite{DanosHarmer} that introduced PA also gave it a fully abstract game semantics.  
Instead, the point of this section will be to demonstrate how the ideas we have outlined can be applied systematically to yield fully abstract models of programming languages.

\section{A Kleisli-style construction for parametric monads}

\subsection{Parametric monads}

Let $\M$ be a monoidal category and let $\C$ be a category.  
Then a \emph{lax left action} of $\M$ on $\C$ is a functor $\_.\_\from \M\times\C\to \C$ that gives rise (through currying) to a lax monoidal functor $\M\to \End[\C,\C]$.  
In other words, we have natural transformations $\passoc_{X,Y,A}\from X.Y.A\to (X\tensor Y).A$ and $\lun_A\from A \to I.A$ making the following diagrams commute for all objects $A$ of $\C$ and $X,Y,Z$ of $\M$.

\begin{mathpar}
  \begin{tikzcd}[column sep=6em]
    X.Y.Z.A \arrow[dr,"X.\passoc_{Y,Z,A}"'] \arrow[r, "\passoc_{X,Y,Z.A}"]
      & (X \tensor Y).Z.A \arrow[r, "\passoc_{X\tensor Y,Z,A}"]
        & ((X \tensor Y) \tensor Z).A \arrow[d, "\assoc_{X,Y,Z}.A"] \\
    %
      & X.(Y\tensor Z).A \arrow[r, "\passoc_{X,Y\tensor Z,A}"]
        & (X\tensor(Y\tensor Z)).A
  \end{tikzcd}
  \and
  \begin{tikzcd}
    X.A \arrow[r, "\lun_{X.A}"] \arrow[dr, "\lunit_X.A"']
      & I.X.A \arrow[d, "\passoc_{I,X,A}"] \\
    %
      & (I \tensor X) . A
  \end{tikzcd}
  \and
  \begin{tikzcd}
    X.A \arrow[r, "X.\lun_A"] \arrow[dr, "\runit_X.A"']
      & X.I.A \arrow[d, "\passoc_{X,I,A}"] \\
    %
      & (X\tensor I).A
  \end{tikzcd}
\end{mathpar}

\begin{example}
  \begin{itemize}
    \item Any monad $M$ is an action of the trivial category on its underlying category $\C$, regarding $MA$ as the action $I.A$.
      The natural transformation $\passoc_{A,I,I}$ is precisely the monad action on $A$:
      \[
        I.I.A = MMA \to M A = I.A = (I\tensor I).A\,.
        \]
      Dually, any lax action gives rise to a monad on the category being acted upon, by setting $MA = A.I$.
    \item If $\C$ is also a monoidal category and $J\from \M\to \C$ is a lax monoidal functor with monoidal coherence $\mu$, then there is an action of $\M^{co}$ (i.e., $\M$ with the opposite monoidal product) on $\C$ given by
      \[
        A.X = A \tensor JX\,,
        \]
      and
      \[
        \passoc_{X,Y,A}=
        (A \tensor JY) \tensor JX \xrightarrow{\assoc_{A,JX,JY}}
        A \tensor (JY \tensor JX) \xrightarrow{A \tensor \mu_{X,Y}}
        A \tensor J(Y\tensor X)\,.
        \]
      We sometimes refer to a left action of the opposite category $\M^{co}$ on $\C$ as a \emph{right action} of $\M$ on $\C$.  
      In that case, we write $X.A$ instead of $A.X$, so that the coherences become
      \begin{gather*}
        \passoc_{A,X,Y}\from A.X.Y \to A.(X\tensor Y)\\
        \run_A\from A \to A.I\,.
      \end{gather*}

    \item If $\C$ is a monoidal closed category, and $j$ an oplax monoidal functor with coherence $\nu$, then there is an action of $\M^{op}$ on $\C$ given by
      \[
        A.X = jX \implies A
        \]
      and
      \[
        \passoc_{A,X,Y}=jY \implies (jX \implies A) \to
        (jY \tensor jX) \implies A \xrightarrow{\nu_{Y,X}\implies A}
        j(Y \tensor X) \implies A\,.
        \]
    \item The intersection of the first two examples is the \emph{writer monad} given by $M_WX = X\tensor W$ for any monoid $W$ in $\C$.  
      The intersection of the first and third examples is the \emph{reader monad} given by $M^RX = R \implies X$ for any comonoid $R$ in $\C$ (and, in particular, for any object $R$ if $\C$ if the monoidal product in $\C$ is Cartesian).
      
      We shall therefore call an action of the form $A \tensor JX$ a \emph{writer-style action} and one of the form $jX \implies A$ a \emph{reader-style action}.
    \item We can define an \emph{oplax action} of $\M$ on $\C$ to be a lax action of $\M$ upon the opposite category $\C^{op}$.  
      In this case, the coherence $\passoc$ goes from $A.(X\tensor Y)$ to $A.X.Y$.  
      As monads are lax actions of the trivial category, so are comonads oplax actions of the trivial category.

      Since the functors $\_\tensor U$ and $U\implies \_$ are adjoint, any reader-style lax action $jX \implies A$ may also be regarded as an oplax action $A \tensor jX$.  
      We shall refer to these oplax actions as \emph{reader-style} too.
  \end{itemize}
\end{example}

\subsection{The $\C/\M$ construction}

Suppose we have a lax action of a monoidal category $\M$ upon a category $\C$.  
We define a new category $\C/\M$ as follows.
The objects of $\C/\M$ are the objects of $\C$, while the morphisms are given by the following formula.
\[
  \C/\M(A,B) = \colim_{X\object\M}\C(A,X.B)
  \]
That is, if $A$ and $B$ are objects of $\C$, then a morphism from $A$ to $B$ in $\C/\M$ is an equivalence class of pairs $(X,f)$, where $X$ is an object of $\M$ and $f\from A\to X.B$ a morphism in $\C$, and where $(X,f)$ and $(Y,g)$ are said to be equivalent if there is a morphism $h\from X\to Y$ in $\M$ making the following diagram commute.
\[
  \begin{tikzcd}
    A \arrow[r, "f"] \arrow[dr, "g"']
      & X.B \arrow[d, "h.B"] \\
    %
      & Y.B
  \end{tikzcd}
  \]
Note that this does not automatically define an equivalence relation in general, so there may be pairs $(X,f)$ and $(Y,g)$ that are not related by some $h\from X\to Y$ but are nevertheless equivalent because there is some chain of such relations from one to the other.

For the rest of the paper, we will refer to the pair $(X,f)$ using the morphism $f$, since the object $X$ should usually be clear from context.

Let $A,B,C$ be objects of $\C$, and let $f\from A\to X.B,g\from B\to Y.C$ be morphisms $A\to B$ and $B\to C$ in $\C/\M$.  
We define the composition of $f$ with $g$ to be given by the following composite in $\C$.
\[
  A \xrightarrow{f}
  X.B \xrightarrow{X.g}
  X.Y.C \xrightarrow{\passoc_{X,Y,C}}
  (X\tensor Y).C
  \]
The identity morphism $A\to A$ is given by the morphism $\lun_A\from A \to I.A$ in $\C$.
The coherence conditions for the action guarantee that this is an identity and that our composition is associative.

If we consider the case that $\M$ is trivial, so the action is a monad $M$ given by $MA = I.A$, then this composition becomes
\[
  A \xrightarrow{f}
  M B \xrightarrow{M g}
  M M C \xrightarrow{\passoc_{I,I,C}}
  M C\,,
  \]
which is precisely the usual Kleisli composition.

There is a natural functor $J\from \C \to \C/\M$ that is the identity on objects and that sends the morphism $f\from A \to B$ in $\C$ to the composite
\[
  A \xrightarrow{f}
  B \xrightarrow{\lun_B}
  I.B\,,
  \]
considered as a morphism $A\to B$ in $\C/\M$.

Let us see what that looks like when our action is the action of $\Surj^{+\,op}$ on $\Set$ that we considered earlier.  
In that case, a morphism $A\to B$ is given by a function $A \to [X,B]$, or equivalently $X \to [A,B]$.
We may identify this function with its image, which is a subset of $[A,B]$, and this identification corresponds precisely to the equivalence relation that is automatically given by our construction; namely, the smallest equivalence relation such that $X \to [A,B]$ is equivalent to the composite $Y \to X \to [A,B]$ for any surjection $Y \to X$.
Indeed, if $f\from X \to [A,B]$ and $g \from Y \to [A,B]$ have the same image $\F\subset[A,B]$, then $f$ and $g$ are both equivalent to the inclusion $\F\hookrightarrow [A,B]$, so they are equivalent.

\subsection{Universal property of $\C/\M$}

The category $\C/\M$ has one other piece of structure besides the functor out of $\C$.  
If $X$ is an object of $M$ and $A$ and object of $\C$, then the identity morphism $X.A\to X.A$ may be considered as a morphism $\phi_{X,A}\from J(X.A) \to JA$ in $\C/\M$.  
$\phi_{X,A}$ is natural in $X$ and $A$ and also makes the following diagram commute.
\[
  \begin{tikzcd}
    J(X.Y.A) \arrow[r, "\phi_{X,Y.A}"] \arrow[d, "J\passoc_{X,Y,A}"']
      & J(Y.A) \arrow[d, "\phi_{Y,A}"] \\
    J((X\tensor Y).A) \arrow[r, "\phi_{X\tensor Y,A}"]
      & JA
  \end{tikzcd}
  \]
We call a natural transformation $\psi_{X,A}\from J(X.A) \to JA$ \emph{multiplicative} if it satisfies the same commutative diagram.

$\C/\M$, $J$ and $\phi_{X,A}$ are universal in the following sense.

\begin{proposition}
  i) Let $\C/\M$, $J$ and $\phi_{X,A}$ be as above.  
  Let $\D$ be a category, $F$ a functor $\C\to \D$ and $\psi_{X,A}\from F(X.A) \to FA$ a multiplicative natural transformation in $\D$.  
  Then there is a unique functor $H\from \C/\M\to \D$ such that $F=H J$ and $\psi=H\phi$.

  ii) Let $\D$ be a category and let $H,K\from \C/\M\to \D$ be two functors.  
  Let $\alpha\from HJ \to KJ$ be a natural transformation making the following diagram commute.
  \[
    \begin{tikzcd}
      HJ A \arrow[r, "\alpha_A"] \arrow[d, "H\phi_{X,A}"']
        & KJ A \arrow[d, "K\phi_{X,A}"] \\
      HJ X.A \arrow[r, "\alpha_{X.A}"]
        & KJ A
    \end{tikzcd}
    \]
  Then there is a unique natural transformation $\beta\from H\to K$ such that $\alpha=\beta J$.
  \label{quotient-universal}
\end{proposition}

\begin{proof}
  The proof, which we will not give full details of, comes down to the fact that we can factorize any morphism $f\from A \to X.B$ from $A$ to $B$ in $\C/\M$ as:
  \[
    f = A \xrightarrow{Jf}
    X.B \xrightarrow{\phi_{X,A}}
    B\,,
    \]
  where we have considered $f$ both as a morphism $A\to B$ in $\C/\M$ and as a morphism $A \to X.B$ in $\C$.  
  It therefore suffices to define $H$ on morphisms of the form $Jf$ (which must be sent to $Ff$, since $F=HJ$) and on morphisms of the form $\phi_{X,A}$ (which must be sent to $\psi_{X,A}$, since $\psi=H\phi$).  
  Therefore $H$ is uniquely defined, if it exists, so it suffices to check that the $H$ given by sending the above factorization to the composite
  \[
    FA \xrightarrow{Ff}
    F(X.B) \xrightarrow{\psi_{X,A}}
    FB
    \]
  is indeed a functor satisfying the requirements of the proposition.  
  Part (ii) is proved in a very similar way.
\end{proof}

\begin{remark}
  If $\M$ is the trivial category, so our action is a monad $M$, then this universal property can be used to prove the usual universal property for the Kleisli category; namely, that it is initial among all adjunctions giving rise to $M$.  
  To see this, suppose that $\C \xrightarrow{F} \D \xrightarrow{G} \C$ are functors such that $F$ is left adjoint to $G$ and $M=GF$.  
  Then we have a natural transformation
  \[
    FMA = FGF A \xrightarrow{\epsilon_{F A}} F A\,
    \]
  which satisfies the hypotheses of Proposition \ref{quotient-universal}(i).  
  Therefore, Proposition \ref{quotient-universal} tells us that the Kleisli category is not only initial amongst adjunctions giving rise to $M$, but is initial among all functors $F\from \C \to \D$ that admit a natural transformation $FMA \to FA$.
  Note that for more general $\M$, we do not in general get an adjunction between $\C$ and $\C/\M$.

  The quotient notation we have used is because the universal property we have outlined exhibits $\C/\M$ as a particular weighted coequalizer of the functors $\pr_2,\_.\_\from \M\times\C \rightrightarrows \C$ in $\Cat$.
  It may therefore be regarded as a lax $2$-dimensional analogue of the quotient $X/G$ of a set $X$ by a group or monoid action.  
  
  When the action is a monad, this is a strange idea, since we are not used to thinking of, for example, a Kleisli category as quotient of the original category.  
  The reason for this is the laxness: we do not identify the objects $A$ and $X.A$ with an isomorphism, but with a morphism in one direction.  
  One way in which a Kleisli category does act like a quotient is that it allows us to transfer effects that are usually associated with higher types on to lower types.  
  For example, the type $W\to [A,W]$ encodes a state transformer with state $W$.  
  Working in the Kleisli category for the state monad allows us to associate this stateful behaviour to the object $A$.
\end{remark}
\begin{remark}
  The proof of Proposition \ref{quotient-universal} tells us that one way of thinking of the category $\C/\M$ is as a general theory of categories that extend $\C$, and admit a factorization result whereby every morphism is the composition of a morphism from $\C$ with one of the distinguished morphisms $\phi_{X,A}$.

  Factorization results are very important in the game semantics of effects.  
  What usually happens is that when we extend a model $\G$ to a new model $\G'$, we wish to show that each morphism in $\G'$ may be written as the composite of a morphism from $\G$ composed with one of a small collection of new morphisms that are readily definable in the language -- for example, nondeterministic oracles, or simple storage cells.  
  This allows us to lift a definability result from the old category to the new one.  
  If these new morphisms can be cast as the components of some natural transformation $\psi_{X,A}\from X.A \to A$ for some action of some monoidal category $\M$ on $\G$ (and often they can), then Proposition \ref{quotient-universal}(i) gives us a functor from $\G/\M$ to $\G'$.  
  The factorization result then tells us that this functor is full, and so the model $\G'$ can also be defined as a quotient of $\G/\M$.
\end{remark}

\subsection{Monoidal and monoidal closed structure of $\C/\M$}

We saw in the last section that the $\C/\M$ construction may be regarded as a kind of lax $2$-coequalizer.  
In the category of sets, if a pair of morphisms $f,g\from A \rightrightarrows B$ is \emph{reflexive} -- i.e., if there is a morphism $h\from B \to A$ such that $f\circ h = g\circ h = \id_B$, then the coequalizer of $f$ and $g$ commutes with finite products.  

In our setting, the two functors $\pr_2$ and $\_.\_$ from $\M\times\C \to \C$ form a reflexive pair, since they have a common section $h\from \C \to \M\times \C$ given by $h(A) = (I, A)$.  
It turns out that a similar result then applies.

\begin{proposition}
  Given an action of a monoidal category $\M$ on a category $\C$, and an action of a monoidal category $\M'$ on a category $\C'$, there is an obvious way to define an action of $\M\times\M'$ on $\C\times\C'$.  
  Then the functor
  \[
    (\C\times\C')/(\M\times\M') \to (\C/\M) \times (\C'/\M')
    \]
  induced as in Proposition \ref{quotient-universal} is an isomorphism.
  \label{monoidality}
\end{proposition}

Now suppose that $\C$ is itself a monoidal category.  
We say that the action of $\M$ on $\C$ is \emph{monoidal} if it is a lax monoidal functor $\M\times\C\to\C$, which means that we need to have a natural transformation 
\[
  X.A\tensor Y.B\to (X\tensor Y).(A\tensor B)\,,
  \]
together with appropriate coherences.  

If the action is reader-style, given by $X.A = jX \implies A$ for an oplax monoidal functor $j\from \M\to \C$, then it is sufficient for $\C$ to be a \emph{symmetric} monoidal category, since then we have a natural transformation
\[
  (j X \implies A) \tensor (j Y \implies B)
  \rightarrow
  (j X \tensor j Y) \implies (A \tensor B)
  \rightarrow
  j (X\tensor Y) \implies (A \tensor B)\,.
  \]
Given a monoidal action, we get a natural transformation
\[
  (X\tensor Y).(A\tensor B)
  \rightarrow
  (X.A)\tensor Y.B
  \xrightarrow{\phi_{X,A}\tensor \phi_{Y,B}}
  A\tensor B\,,
  \]
which is multiplicative, inducing a functor $(\C\times\C)/(\M\times\M)\to \C/\M$.  
Composing with the isomorphism from the start of this section, we get a functor $(\C/\M)\times(\C/\M)\to\C/\M$.  
It turns out that this gives $\C/\M$ the structure of a monoidal category and that in this case the functor $J\from \C\to\C/\M$ is a strict monoidal functor.

This generalizes the case of a monoidal monad, whose the Kleisli category is always a monoidal category.

Now, if $\C$ is monoidal closed and the action of $\M$ on $\C$ is a \emph{reader-type action}, then $\C/\M$ also inherits the monoidal closed structure from $\C$.  
Note that this may not be true for arbitrary actions, even for monads.  
For example, the Kleisli category for the power set monad on $\Set$ (which is better known as the category of sets and relations) is monoidal closed, but with inner function space given by the Cartesian product, and not by the function space from $\Set$.

\section{Game Semantics for Probabilistic Algol}

\subsection{The discrete probability monad}

Given a set $X$, we define a \emph{discrete probability measure} on $X$ to be a function $\bP\from\powerset(X)\to[0,1]$ satisfying the following conditions.
\begin{description}
  \item[Empty set] $\bP(\emptyset) = 0$.
  \item[Countable additivity] If $\{E_i\}_{i=0}^\infty$ is a sequence of pairwise-disjoint subsets of $X$, then
    \[
      \bP\left(\bigcup_{i=0}^\infty E_i\right) = \sum_{i=0}^\infty \bP(E_i)\,.
      \]
  \item[Whole space] $\bP(X)=1$.
\end{description}

If instead we have $\bP(X)\le 1$, we say that $\bP$ is a \emph{sub-probability measure}

Note that if $A$ is countable, then $\mu$ may be entirelly specified by its action on singletons: if $A\subseteq X$ is a set, then we have
\[
  \bP(A) = \sum_{a\in A}\bP(\{a\})\,.
  \]

Given a set $X$, we define $P(X)$ to be the set of all discrete probability measures on $X$.  
Then we have natural maps
\begin{mathpar}
  \delta_X\from X \to P(X) \and m_X\from P(P(X)) \to X
\end{mathpar}
given by
\begin{mathpar}
  \delta_X(x)(A) = \begin{cases}
    1 & x\in A \\
    0 & x\not\in A
  \end{cases} \and
  \bP_X(\tau)(A) = \sum_{\bP\in P(X)} \tau(\{\bP\})\bP(A)
\end{mathpar}
$\delta_X$ and $m_X$ give $P$ the structure of a monad on $\Set$, which we will call the \emph{discrete probability monad}.  
This is a discrete form of the monad developed in \cite{Giry}.

We want to exhibit this monad as the colimit of an action, as we did for the power set monad earlier.  
We define a \emph{discrete probability space} to be a pair $(X,\bP_X)$, where $X$ is a set and $\mu$ a discrete probability measure on $X$.  
We will normally refer to this pair using the set $X$.
Given discrete probability spaces $X$ and $Y$, we define a \emph{measure-preserving map} from $X$ to $Y$ to be a function $f\from X \to Y$ such that for all $A\subseteq Y$ we have $\bP(X)(f\inv(A)) = \bP_Y(A)$.
It is clear that discrete probability spaces and measure-preserving maps form a category $\DProb$.

Moreover, $\DProb$ is a monoidal category: given discrete probability spaces $X$ and $Y$, we may define a probability measure on the Cartesian product $X\times Y$ by
\[
  \bP_{X\times Y} (A) = \sum_{(x,y)\in A} \bP_X(\{x\})\bP_Y(\{y\})\,.
  \]

Then we have a natural isomorphism
\[
  P(X) \cong \colim_{(Y,\bP_Y)\object\DProb^{op}} [Y,X]\,,
  \]
such that the monad structure on $P$ is induced from the reader-style action of $\DProb^{op}$ on $\Set$ given by the monoidal functor $\DProb\to\Set$ that sends $(Y,\bP_Y)$ to its underlying set $Y$.

Moreover, the category $\DProb^{op}$ is weakly filtered, and so, as in our earlier discussion, we feel confident using this action, rather than the monad $P$ we have defined, to model discrete probability.  

This action is very closely related to the action of $\Surj^{+,op}$ that we defined earlier; indeed, $\Surj^+$ is equivalent to the category of discrete probability spaces taking probabilities in the Boolean semiring $\{0,1\}$ with countable summation given by maximum.

By cutting down the category $\DProb$ we can obtain slightly different notions of probability.  
For our purposes, we will be using the full subcategory $\BProb$ where the objects $(X,\bP_X)$ are those that satisfy the following three additional conditions.
\begin{description}
  \item[Countability] The set $X$ is countable.
  \item[Finite support] There is a finite subset $E\subseteq X$ such that $\bP_X(E)=1$.
\end{description}

The action of $\BProb^{op}$ gives rise to a monad on the category of countable sets.  

\subsection{Probabilistic Algol}

\cite{DanosHarmer} gives a fully abstract game semantics for the language Probabilistic Algol (PA).  
The base language for PA is the language Idealized Algol (IA) from \cite{SamsonGuyIAPassive}, and it has been extended with a constants $\coin\from\bool$.  
To make things a little more interesting, we will extend this further to incorporate an infinite family of constants $\coin_p\from\bool$, where $p$ ranges over the real interval $[0,1]$.  

We give the language a small-step operational semantics.  
The rules for the deterministic terms may be derived from the operational semantics given in \cite{SamsonGuyIAPassive}; for example:
\[
  \inferrule*{ }{\ia s {v \coloneqq n} \opto \ia {\stup s v n} \skipp}
  \]
See also \cite{JimGuySmallStep}.

We add two small-step rules for the $\coin_p$ primitives:

\begin{mathpar}
  \inferrule*[left={heads${}_p$}]{ }{\ia s \coin_p \opto \ia s \true}
  \and
  \inferrule*[left={tails${}_{1-p}$}]{ }{\ia s \coin_p \opto \ia s \false}\,.
\end{mathpar}

These are the only nondeterministic parts of the operational semantics.  

Given a small-step evaluation $\pi = M \to M_1 \to \cdots \to \x$ of a term $M$ of ground type $o$, we define the \emph{probability} $p(\pi)$ of $\pi$ to be the product of all the indices $q$ belonging to \LeftTirName{heads${}_q$} or \LeftTirName{tails${}_q$} rules.

This defines a discrete sub-probability measure on the set corresponding to the ground type $o$ given by
\[
  \bP(\{x\}) = \sum_{\substack{\text{evaluations}\\\pi = M \to\dots \x}}p(\pi)\,.
  \]
This is only a subprobability measure, because some evaluations may continue forever.

\cite{DanosHarmer} shows how we can define other probabilistic terms using $\coin$.  
Specifically, they define a term $\polydie\from\bN\to\bN$, where the behaviour of $\polydie\,n$ is to return the result of tossing an $n$-sided die (with sides numbered $0$ to $n-1$), with each outcome occurring with probability $1/n$.  
The definition of $\polydie\,n$ in terms of $\coin$ works as follows.  
We choose some number $k$ such that $2^k\ge n$ and then toss the coin $n$ times to give one of $2^k$ outcomes.  
If an outcome corresponds (under some fixed correspondence $n\hookrightarrow 2^k$) to a natural number below $n$, then we return that number; otherwise, we repeat the process until we get such a number.  

This process will terminate with probability $1$, and since each $m<n$ occurs with equal probability, they must all occur with probability $1/n$.

\subsection{Extending a semantics for IA to a semantics for PA}

Let $\G$ be a category that admits a fully abstract adequate semantics for Idealized Algol.  
See \cite{SamsonGuyIAPassive} for a list of the conditions that such a category should satisfy, and also for the best known example, the category of games and visible strategies.

As explained in \cite{SamsonGuyIAPassive}, $\G$ should be Cartesian closed and there should be a lax monoidal functor $\Set\to \G$ that gives the denotation of the ground types $\nat$,$\bool$ and $\com$, together with their structural functions.
We can therefore get a lax monoidal functor $\BProb \to \G$ by composing this with the forgetful functor $\BProb\to\Set$.

This gives rise to a reader-style action of $\BProb^{op}/\G$, and the resulting category $\G/\BProb^{op}$ is therefore a symmetric monoidal closed category.  

\subsection{Testing morphisms and plays}

The equivalence relation on morphisms is still too weak for our purposes.  
For example, if the boolean type $\bB$ carries a Bernoulli distribution with coefficient $p$, then the diagonal map $\Delta\from \bB\to \bB\times\bB$ should be equivalent to the identity $\id\from\bB\times\bB\to\bB\times\bB$ as terms of type $\bB\times\bB$, because the projections on to each component are equivalent.  
However, they are not yet equivalent in our category.  

To improve the equivalence relation, we introduce the concept of \emph{testing morphism} for an object $A$ that is the denotation of an Idealized Algol term.
This is a term of type $(\bN \to A) \to A$ that is the denotation of an Idealized Algol term of the form
\[
  \test_{n_1,\cdots,n_k} = \lambda f.\new\;v\coloneqq 0 \text{ in } f(v \coloneqq \deref v + 1; \case\,v\,\_\,n_1\,\cdots\,n_k\,\Omega)\,,
  \]
where $n_1,\cdots,n_k$ is a sequence of numbers.  
The effect of this term is to call $f$, and to pass in the numbers $n_1,\cdots,n_k$ in turn, and diverging if $f$ calls its argument more than $k$ times.
In game semantics, the sequence $n_1,\cdots,n_k$ is more easily recognized as a sequence of moves occurring in the game $\bN$ on the left.  

Given a morphism $\sigma\from \bN \to A$, we say that the sequence $n_1,\cdots,n_k$ is a \emph{play} of $\sigma$ if it is minimal (with respect to the prefix ordering) such that $\test_{n_1,\cdots,n_k}(\sigma)$ represents a non-diverging term.
In that case, the \emph{result} of the play is the strategy $\test_{n_1,\cdots,n_k}(\sigma)$ for $A$.

Now, if the set $\bN$ carries a probability distribution, then this gives rise to a sub-probability distribution on the set of plays for $\sigma$, where the probability associated to the sequence $n_1,\cdots,n_k$ is the product of the probabilities of the $n_i$.  
This then induces a discrete probability distribution on the set of morphisms $1\to A$.

We say that two morphisms $\sigma,\tau\from \bN\to A$ from $1$ to $A$ in $\G/\BProb$ are equivalent if they give rise to the same probability distribution on the set of strategies for $A$.  
This equivalence relation refines our earlier one.

\subsection{Single-threaded morphisms}

Our category is symmetric monoidal closed, but not yet Cartesian closed.  
A trick that is often used in Game Semantics (see, for example, \cite{mcCHFiniteND} and \cite{DanosHarmer}) is to pass to a category of \emph{single-threaded} strategies; this is equivalent to cutting down to those morphisms that are comonoid homomorphisms.  

Note that, in our category, every object has a natural commutative comonoid structure that arises from diagonal $\Delta\from A\to A\times A$ in the original category.  
We say that a morphism $\sigma\from A\to B$ is \emph{single-threaded} if it is a homomorphism of the comonoid structures on $A$ and $B$; i.e., if the following square commutes.
\[
  \begin{tikzcd}
    A \arrow[r, "\sigma"] \arrow[d, "\Delta"']
      & B \arrow[d, "\Delta"] \\
    A \times A \arrow[r, "\sigma\times\sigma"]
      & B \times B
  \end{tikzcd}
  \]
Since the category of commutative comonoids in a symmetric monoidal category is automatically Cartesian closed (see, for example, \cite{Freyd}), this gives us a Cartesian closed category.

The deterministic terms are all comonoid homomorphisms.  
As long as we have applied the equivalence relation outlined above, the natural morphisms $\phi_{X,A}$ are also comonoid homomorphisms.

\subsection{Denotational semantics and adequacy}

We may now inductively build up a denotational semantics for PA.  
The deterministic terms may all be defined inside the base category $\G$ and transported into our new category via the natural inclusion.  
The probabilistic term $\coin_p$ is given by the natural morphism $\phi_{B_p, 1}$, where $B_p$ is a Bernoulli space with coefficient $p$.  
That is to say, it is given by the pair
\[
  ((\{H,T\}, \mu(H)=p, \mu(T)=1-p), 1 \to (\{H,T\} \to \bB))\,
  \]
where the function on the right sends $H$ to $\true$ and $T$ to $\false$.

Note now that the denotation of a term $M = C[\coin_{p_1},\cdots,\coin_{p_j}]T$ is given by the following morphism.
\[
  \bB^j
  \xrightarrow{\deno{b_1,\cdots,b_j\ts C[b_1,\cdots,b_j]}}
  \deno{T}\,,
  \]
where the distribution on the product $\bB^j$ is the product of Bernoulli distributions.

Fix an injection $r\from\bB^j\to \bN$ (for instance, the one given by ibinary representation) and suitable projection functions $\pr_i \from \bN \to \bB$ such that $\pr_i(r(v))$ is the $i$-th entry of $v$.
Let $\multicoin\from\nat$ be the term (depending on the values of the $p_i$) given by
\[
  (r\;\coin_{p_1}\,\cdots\,\coin_{p_j})\,.
  \]
Now the operational semantics of $\pr_i(\multicoin)$ is the same as the operational semantics of $\coin_{p_i}$, since the projections from the product are probability-preserving.  
This means that any evaluation $\pi$ of the term $M$ may be pegged to an evaluation of the term formed by replacing each instance of $\coin_{p_i}$ in $M$ with $\pr_i(\multicoin)$.

\begin{proposition}[Computational Adequacy]
  Let $M = C[\multicoin]\from \com$ be a term of Idealized Algol, where $C$ is a multi-holed deterministic IA context.
  Let $p$ be the sum of the probabilities of all evaluation sequences of $M$ that terminate at $\skipp$.

  The denotation of $M$ is a morphism $\bN \to \bC$ as outlined above.

  Then we get an induced sub-probability distribution on the set of morphisms $1\to A$.  
  The adequacy result is that $p$ is the same as the induced probability of the morphism $\deno{\skipp}$.
\end{proposition}
\begin{proof}
  Each terminating evaluation sequence of $M$ corresponds to a finite sequence $n_1,\cdots,n_k$ of the different values that $\multicoin$ takes on over the course of the evaluation of the term.  
  By inspection, we may peg this evaluation of $M$ exactly to the evaluation of the term $\test_{n_1,\cdots,n_k} (\lambda n.C[n])$ in pure deterministic Idealized Algol, and therefore this IA term must converge.  
  By the Adequacy result for Idealized Algol \cite{SamsonGuyIAPassive}, an IA term converges to $\skipp$ if and only if its denotation is $\deno{\skipp}$.  
  Therefore, there is bijective matching between terminating evaluation sequences of $M$ and plays of the morphism $\deno{M}$, with each one getting the same probability.  
  The result follows.
\end{proof}

\subsection{Full Abstraction}

In order to prove full abstraction for our model, we will define a further equivalence on morphisms.  
Say that two morphisms $f,g\from A \to B$ are \emph{intrinsically equivalent} if and only if for all morphisms $\alpha\from (A\to B)\to\bC$, $\alpha(f)$ and $\alpha(g)$ are probabilistically equivalent in the sense given above.
Then our full abstraction result becomes:

\begin{proposition}[Full Abstraction]
  Let $M,N\from T$ be two PA terms.  
  Then $M$ and $N$ are observationally equivalent if and only if their denotations $\deno{M}$ and $\deno{N}$ are intrinisically equivalent.
\end{proposition}

One direction (soundness) follows immediately from our Computational Adequacy result.  
To prove the other direction, it suffices to show that any compact strategy is definable \cite{CurienFullAbstraction}, where we say that a morphism $\sigma\from A \to (X \to B)$ from $A$ to $B$ is \emph{compact} if it is compact when considered as a morphism in $\G$.
We prove this using a factorization result:
\begin{lemma}[Deterministic factorization]
  Let $\sigma\from A \to B$ be a morphism in $\G/\BProb^{op}$.  
  Then $\sigma$ may be factorized as $\text{Det}(\sigma)(\multicoin)$, where $\text{Det}(\sigma)\from \bN \to A \to B$ is a strategy in the image of the inclusion functor $J\from \G \to \G/\BProb^{op}$, and $\multicoin$ is defined for some values $p_1,\cdots,p_k$.
\end{lemma}
\begin{proof}
  Treat $\sigma$ as a morphism $A \to X \to B$ in $\G$.  
  Since $X$ is finitely supported, there is a probability-preserving function $\bN \to X$, for some finitely supported distribution on $\bN$.  
  So $\sigma$ is equivalent to a morphism $A \to \bN \to B$, and then the factorization is automatic.
\end{proof}

\bibliographystyle{spphys}
\bibliography{effects}

\end{document}
